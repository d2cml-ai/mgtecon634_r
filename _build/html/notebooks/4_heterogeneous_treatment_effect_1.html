
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>4. HTE I: Binary treatment &#8212; MGTECON 634 at Stanford (R scripts)</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="5. Policy Evaluation I - Binary Treatment" href="5_policy_evaluation_1.html" />
    <link rel="prev" title="3. ATE I: Binary treatment" href="3_average_treatment_effect_1.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../_static/logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">MGTECON 634 at Stanford (R scripts)</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../intro.html">
                    Machine Learning-Based Causal Inference
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Topics
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../md/1_introduction_1.html">
   1. Introduction
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="2_Introduction_to_Machine_Learning_1.html">
   2. Introduction to Machine Learning
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="3_average_treatment_effect_1.html">
   3. ATE I: Binary treatment
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   4. HTE I: Binary treatment
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="5_policy_evaluation_1.html">
   5. Policy Evaluation I - Binary Treatment
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="6_Policy_Learning_1.html">
   6. Policy Learning I - Binary Treatment
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="7_LM_forest_RDD_1.html">
   7. LM Forest RDD
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="8_MCPanel.html">
   8. Matrix completion Methods for Causal Panel Data Models
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="9_surrogate_r.html">
   9. Athey, S., Chetty, R., Imbens, G. W., &amp; Kang, H. (2019). The surrogate index: Combining short-term proxies to estimate long-term treatment effects more rapidly and precisely (No. w26463). National Bureau of Economic Research.
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<div class="menu-dropdown menu-dropdown-launch-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Launch interactive content">
      <i class="fas fa-rocket"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://mybinder.org/v2/gh/d2cml-ai/mgtecon634_r/master?urlpath=tree/_build/jupyter_execute/notebooks/4_heterogeneous_treatment_effect_1.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Launch on Binder"
>
  

<span class="headerbtn__icon-container">
  
    <img src="../_static/images/logo_binder.svg">
  </span>
<span class="headerbtn__text-container">Binder</span>
</a>

      </li>
      
      <li>
        <a href="https://colab.research.google.com/github/d2cml-ai/mgtecon634_r/blob/master/_build/jupyter_execute/notebooks/4_heterogeneous_treatment_effect_1.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Launch on Colab"
>
  

<span class="headerbtn__icon-container">
  
    <img src="../_static/images/logo_colab.png">
  </span>
<span class="headerbtn__text-container">Colab</span>
</a>

      </li>
      
      <li>
        
<button onclick="initThebeSBT()"
  class="headerbtn headerbtn-launch-thebe"
  data-toggle="tooltip"
data-placement="left"
title="Launch Thebe"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-play"></i>
  </span>
<span class="headerbtn__text-container">Live Code</span>
</button>

      </li>
      
    </ul>
  </div>
</div>

<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-repository-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Source repositories">
      <i class="fab fa-github"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://github.com/d2cml-ai/mgtecon634_r"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Source repository"
>
  

<span class="headerbtn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="headerbtn__text-container">repository</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/d2cml-ai/mgtecon634_r/issues/new?title=Issue%20on%20page%20%2Fnotebooks/4_heterogeneous_treatment_effect_1.html&body=Your%20issue%20content%20here."
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Open an issue"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="headerbtn__text-container">open issue</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/d2cml-ai/mgtecon634_r/edit/master/_build/jupyter_execute/notebooks/4_heterogeneous_treatment_effect_1.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Edit this page"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="headerbtn__text-container">suggest edit</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="../_sources/notebooks/4_heterogeneous_treatment_effect_1.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.ipynb</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#pre-specified-hypotheses">
   4.1. Pre-specified hypotheses
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#data-driven-hypotheses">
   4.2. Data-driven hypotheses
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#via-causal-trees">
     4.2.1. Via causal trees
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#via-grf">
     4.2.2. Via grf
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#data-driven-subgroups">
       4.2.2.1. Data-driven subgroups
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#best-linear-projection">
       4.2.2.2. Best linear projection
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#assessing-heterogeneity">
       4.2.2.3. Assessing heterogeneity
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#partial-dependence">
       4.2.2.4. Partial dependence
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#further-reading">
   4.3. Further reading
  </a>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>HTE I: Binary treatment</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#pre-specified-hypotheses">
   4.1. Pre-specified hypotheses
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#data-driven-hypotheses">
   4.2. Data-driven hypotheses
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#via-causal-trees">
     4.2.1. Via causal trees
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#via-grf">
     4.2.2. Via grf
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#data-driven-subgroups">
       4.2.2.1. Data-driven subgroups
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#best-linear-projection">
       4.2.2.2. Best linear projection
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#assessing-heterogeneity">
       4.2.2.3. Assessing heterogeneity
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#partial-dependence">
       4.2.2.4. Partial dependence
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#further-reading">
   4.3. Further reading
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <div class="cell tag_remove_input docutils container">
</div>
<section class="tex2jax_ignore mathjax_ignore" id="hte-i-binary-treatment">
<h1><span class="section-number">4. </span>HTE I: Binary treatment<a class="headerlink" href="#hte-i-binary-treatment" title="Permalink to this headline">#</a></h1>
<p>Source RMD file: <a class="reference external" href="https://docs.google.com/uc?export=download&amp;id=1FSUi4WLfYYKnvWsNWypiQORhkqf5IlFP">link</a></p>
<p>In the previous chapter, we learned how to estimate the effect of a binary treatment averaged over the entire population. However, the average may obscure important details about how different individuals react to the treatment. In this chapter, we will learn how to estimate the <strong>conditional average treatment effect (CATE)</strong>,</p>
<div class="amsmath math notranslate nohighlight" id="equation-ce2c6f5f-7a55-40c4-aba3-32a9d9e6121a">
<span class="eqno">(4.1)<a class="headerlink" href="#equation-ce2c6f5f-7a55-40c4-aba3-32a9d9e6121a" title="Permalink to this equation">#</a></span>\[\begin{equation} \label{eq:cate} \tag{4.1}
  \tau(x) := \mathbf{E}[Y_i(1) - Y_i(0) | X_i = x],
\end{equation}\]</div>
<p>which is a “localized” version of the average treatment effect conditional on a vector of observable characteristics.</p>
<p>It’s often the case that \eqref{eq:cate} is too general to be immediately useful, especially when the observable covariates are high-dimensional. It can be hard to estimate reliably without making strong modeling assumptions, and hard to summarize in a useful manner after estimation. In such situations, we will instead try to estimate treatment effect averages for simpler groups</p>
<div class="amsmath math notranslate nohighlight" id="equation-f0bde426-a0ca-4781-9b09-31e975be8e7f">
<span class="eqno">(4.2)<a class="headerlink" href="#equation-f0bde426-a0ca-4781-9b09-31e975be8e7f" title="Permalink to this equation">#</a></span>\[\begin{equation} \label{eq:cate-g} \tag{4.2}
  \mathbf{E}[Y_i(1) - Y_i(0) | G_i = g],
\end{equation}\]</div>
<p>where <span class="math notranslate nohighlight">\(G_i\)</span> indexes subgroups of interest. Below you’ll learn how to estimate and test hypotheses about pre-defined subgroups, and also how to discover subgroups of interest from the data. In this tutorial, you will learn how to use estimates of \eqref{eq:cate} to suggest relevant subgroups <span class="math notranslate nohighlight">\(G_i\)</span> (and in the next chapters you will find out other uses of \eqref{eq:cate} in policy learning and evaluation).</p>
<p>We’ll continue using the abridged version of the General Social Survey (GSS) <a class="reference external" href="https://gss.norc.org/Documents/reports/project-reports/GSSProject%20report32.pdf">(Smith, 2016)</a> dataset that was introduced in the previous chapter. In this dataset, individuals were sent to treatment or control with equal probability, so we are in a randomized setting. However, many of the techniques and code shown below should also work in an observational setting provided that unconfoundedness and overlap are satisfied (these assumptions were defined in the previous chapter).</p>
<p>As with other chapters in this tutorial, the code below should still work by replacing the next snippet of code with a different dataset, provided that you update the key variables <code class="docutils literal notranslate"><span class="pre">treatment</span></code>, <code class="docutils literal notranslate"><span class="pre">outcome</span></code>, and <code class="docutils literal notranslate"><span class="pre">covariates</span></code> below. Also, please make sure to read the comments as they may be subtle differences depending on whether your dataset was created in a randomized or observational setting.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># The causalTree package is not in CRAN, the most common R repository.</span>
<span class="c1"># To install it, uncomment the next lines as appropriate.</span>
<span class="c1"># install.packages(&quot;devtools&quot;)  # if you don&#39;t have this installed yet.</span>
<span class="c1"># devtools::install_github(&#39;susanathey/causalTree&#39;) </span>
<span class="nf">library</span><span class="p">(</span><span class="n">causalTree</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Loading required package: rpart
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Loading required package: rpart.plot
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Loading required package: data.table
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Attaching package: ‘data.table’
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>The following objects are masked from ‘package:reshape2’:

    dcast, melt
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># use e.g., install.packages(&quot;grf&quot;) to install any of the following packages.</span>
<span class="nf">library</span><span class="p">(</span><span class="n">grf</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">rpart</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">glmnet</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">splines</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">lmtest</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">sandwich</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">ggplot2</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">MASS</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Loading required package: Matrix
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Loaded glmnet 4.1-4
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Loading required package: zoo
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Attaching package: ‘zoo’
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>The following objects are masked from ‘package:base’:

    as.Date, as.Date.numeric
</pre></div>
</div>
</div>
</div>
<p>As with other chapters in this tutorial, the code below should still work by replacing the next snippet of code with a different dataset, provided that you update the key variables <code class="docutils literal notranslate"><span class="pre">treatment</span></code>, <code class="docutils literal notranslate"><span class="pre">outcome</span></code>, and <code class="docutils literal notranslate"><span class="pre">covariates</span></code> below. Also, please make sure to read the comments as they may be subtle differences depending on whether your dataset was created in a randomized or observational setting.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Read in data</span>
<span class="n">data</span> <span class="o">&lt;-</span> <span class="nf">read.csv</span><span class="p">(</span><span class="s">&quot;https://docs.google.com/uc?id=1kSxrVci_EUcSr_Lg1JKk1l7Xd5I9zfRC&amp;export=download&quot;</span><span class="p">)</span>
<span class="n">n</span> <span class="o">&lt;-</span> <span class="nf">nrow</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

<span class="c1"># Treatment: does the the gov&#39;t spend too much on &quot;welfare&quot; (1) or &quot;assistance to the poor&quot; (0)</span>
<span class="n">treatment</span> <span class="o">&lt;-</span> <span class="s">&quot;w&quot;</span>

<span class="c1"># Outcome: 1 for &#39;yes&#39;, 0 for &#39;no&#39;</span>
<span class="n">outcome</span> <span class="o">&lt;-</span> <span class="s">&quot;y&quot;</span>

<span class="c1"># Additional covariates</span>
<span class="n">covariates</span> <span class="o">&lt;-</span> <span class="nf">c</span><span class="p">(</span><span class="s">&quot;age&quot;</span><span class="p">,</span> <span class="s">&quot;polviews&quot;</span><span class="p">,</span> <span class="s">&quot;income&quot;</span><span class="p">,</span> <span class="s">&quot;educ&quot;</span><span class="p">,</span> <span class="s">&quot;marital&quot;</span><span class="p">,</span> <span class="s">&quot;sex&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="pre-specified-hypotheses">
<h2><span class="section-number">4.1. </span>Pre-specified hypotheses<a class="headerlink" href="#pre-specified-hypotheses" title="Permalink to this headline">#</a></h2>
<p>We will begin by learning how to test pre-specified null hypotheses of the form</p>
<div class="amsmath math notranslate nohighlight" id="equation-db72c37f-2f09-43a8-af01-207246aba73b">
<span class="eqno">(4.3)<a class="headerlink" href="#equation-db72c37f-2f09-43a8-af01-207246aba73b" title="Permalink to this equation">#</a></span>\[\begin{equation} \label{eq:hte-hyp} \tag{4.3}
  H_{0}: \mathbf{E}[Y(1) - Y(0) | G_i = 1] = \mathbf{E}[Y(1) - Y(0) | G_i = 0].
\end{equation}\]</div>
<p>That is, that the treatment effect is the same regardless of membership to some group
<span class="math notranslate nohighlight">\(G_i\)</span>. Importantly, for now we’ll assume that the group <span class="math notranslate nohighlight">\(G_i\)</span> was <strong>pre-specified</strong> – it was decided <em>before</em> looking at the data.</p>
<p>In a randomized setting, if the both the treatment  <span class="math notranslate nohighlight">\(W_i\)</span> and group membership <span class="math notranslate nohighlight">\(G_i\)</span> are binary, we can write</p>
<div class="amsmath math notranslate nohighlight" id="equation-3da16f6b-f512-46c1-bdbb-f8a805e653b8">
<span class="eqno">(4.4)<a class="headerlink" href="#equation-3da16f6b-f512-46c1-bdbb-f8a805e653b8" title="Permalink to this equation">#</a></span>\[\begin{equation} \label{eq:linear} \tag{4.4}
  \mathbf{E}[Y_i(W_i)|G_i] = \mathbf{E}[Y_i|W_i, G_i] = \beta_0 + \beta_w W_i + \beta_g G_i + \beta_{wg} W_i G_i
\end{equation}\]</div>
<font size=1>
When $W_i$ and $G_i$ are binary, this decomposition is true without loss of generality. Why?
</font>
<p>This allows us to write the average effects of <span class="math notranslate nohighlight">\(W_i\)</span> and <span class="math notranslate nohighlight">\(G_i\)</span> on <span class="math notranslate nohighlight">\(Y_i\)</span> as</p>
<div class="amsmath math notranslate nohighlight" id="equation-fa1d836c-af2d-46a1-91c2-055d14f9d9dc">
<span class="eqno">(4.5)<a class="headerlink" href="#equation-fa1d836c-af2d-46a1-91c2-055d14f9d9dc" title="Permalink to this equation">#</a></span>\[\begin{equation}  \label{eq:decomp} \tag{4.5}
  \begin{aligned} 
    \mathbf{E}[Y(1) | G_i=1] &amp;= \beta_0 + \beta_w W_i + \beta_g G_i + \beta_{wg} W_i G_i, \\
    \mathbf{E}[Y(1) | G_i=0] &amp;= \beta_0 + \beta_w W_i,  \\
    \mathbf{E}[Y(0) | G_i=1] &amp;= \beta_0 + \beta_g G_i,  \\
    \mathbf{E}[Y(0) | G_i=0] &amp;= \beta_0.
  \end{aligned}
\end{equation}\]</div>
<p>Rewriting the null hypothesis \eqref{eq:hte-hyp} in terms of the decomposition \eqref{eq:decomp}, we see that it boils down to a test about the coefficient in the interaction: <span class="math notranslate nohighlight">\(\beta_{xw} = 0\)</span>. Here’s an example that tests whether the treatment effect is the same for “conservative” (<code class="docutils literal notranslate"><span class="pre">polviews</span></code> &lt; 4) and “liberal” (<code class="docutils literal notranslate"><span class="pre">polviews</span></code> <span class="math notranslate nohighlight">\(\geq\)</span> 4) individuals.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Only valid in randomized settings</span>

<span class="c1"># Suppose this his group was defined prior to collecting the data</span>
<span class="n">data</span><span class="o">$</span><span class="n">conservative</span> <span class="o">&lt;-</span> <span class="nf">factor</span><span class="p">(</span><span class="n">data</span><span class="o">$</span><span class="n">polviews</span> <span class="o">&lt;</span> <span class="m">4</span><span class="p">)</span>  <span class="c1"># a binary group</span>
<span class="n">group</span> <span class="o">&lt;-</span> <span class="s">&#39;conservative&#39;</span>

<span class="c1"># Recall from last chapter -- this is equivalent to running a t-test</span>
<span class="n">fmla</span> <span class="o">&lt;-</span> <span class="nf">formula</span><span class="p">(</span><span class="nf">paste</span><span class="p">(</span><span class="n">outcome</span><span class="p">,</span> <span class="s">&#39; ~ &#39;</span><span class="p">,</span> <span class="n">treatment</span><span class="p">,</span> <span class="s">&#39;*&#39;</span><span class="p">,</span> <span class="n">group</span><span class="p">))</span>
<span class="n">ols</span> <span class="o">&lt;-</span> <span class="nf">lm</span><span class="p">(</span><span class="n">fmla</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
<span class="nf">coeftest</span><span class="p">(</span><span class="n">ols</span><span class="p">,</span> <span class="n">vcov</span><span class="o">=</span><span class="nf">vcovHC</span><span class="p">(</span><span class="n">ols</span><span class="p">,</span> <span class="n">type</span><span class="o">=</span><span class="s">&#39;HC2&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>t test of coefficients:

                     Estimate Std. Error t value  Pr(&gt;|t|)    
(Intercept)         0.4836473  0.0050842  95.127 &lt; 2.2e-16 ***
w                  -0.3789182  0.0058604 -64.657 &lt; 2.2e-16 ***
conservativeTRUE   -0.1590214  0.0092479 -17.195 &lt; 2.2e-16 ***
w:conservativeTRUE  0.1160034  0.0103710  11.185 &lt; 2.2e-16 ***
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
</pre></div>
</div>
</div>
</div>
<font size=1>
Interpret the results above. The coefficient $\beta_{xw}$ is denoted by `w:conservativeTRUE`. Can we detect a difference in treatment effect for conservative vs liberal individuals? For whom is the effect larger?
</font>
<p>Sometimes there are many subgroups, leading to multiple hypotheses such as</p>
<div class="amsmath math notranslate nohighlight" id="equation-86e255f4-5be3-4d82-821a-4eaf93f7ee6f">
<span class="eqno">(4.6)<a class="headerlink" href="#equation-86e255f4-5be3-4d82-821a-4eaf93f7ee6f" title="Permalink to this equation">#</a></span>\[\begin{equation} \label{eq:mult-hyp} \tag{4.6}
H_0: \mathbf{E}[Y(1) - Y(0) \ | \  G_i = 1] = \mathbf{E}[Y(1) - Y(0) \ | \  G_i = g]
\qquad
\text{for many values of }g.
\end{equation}\]</div>
<p>In that case, we need to correct for the fact that we are testing for multiple hypotheses, or we will end up with many false positives. The <strong>Bonferroni correction</strong> <a class="reference external" href="https://en.wikipedia.org/wiki/Bonferroni_correction">(wiki)</a> is a common method for dealing with multiple hypothesis testing, though it is often too conservative to be useful. It is available via the function <code class="docutils literal notranslate"><span class="pre">p.adjust</span></code> from base <code class="docutils literal notranslate"><span class="pre">R</span></code>. The next snippet of code tests whether the treatment effect at each level of <code class="docutils literal notranslate"><span class="pre">polviews</span></code> is different from the treatment effect from <code class="docutils literal notranslate"><span class="pre">polviews</span></code> equals one.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Only valid in randomized setting.</span>

<span class="c1"># Example: these groups must be defined prior to collecting the data.</span>
<span class="n">group</span> <span class="o">&lt;-</span> <span class="s">&#39;polviews&#39;</span>

<span class="c1"># Linear regression.</span>
<span class="n">fmla</span> <span class="o">&lt;-</span> <span class="nf">formula</span><span class="p">(</span><span class="nf">paste</span><span class="p">(</span><span class="n">outcome</span><span class="p">,</span> <span class="s">&#39; ~ &#39;</span><span class="p">,</span> <span class="n">treatment</span><span class="p">,</span> <span class="s">&#39;*&#39;</span><span class="p">,</span> <span class="s">&#39;factor(&#39;</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="s">&#39;)&#39;</span><span class="p">))</span>
<span class="n">ols</span> <span class="o">&lt;-</span> <span class="nf">lm</span><span class="p">(</span><span class="n">fmla</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
<span class="n">ols.res</span> <span class="o">&lt;-</span> <span class="nf">coeftest</span><span class="p">(</span><span class="n">ols</span><span class="p">,</span> <span class="n">vcov</span><span class="o">=</span><span class="nf">vcovHC</span><span class="p">(</span><span class="n">ols</span><span class="p">,</span> <span class="n">type</span><span class="o">=</span><span class="s">&#39;HC2&#39;</span><span class="p">))</span>

<span class="c1"># Retrieve the interaction coefficients</span>
<span class="n">interact</span> <span class="o">&lt;-</span> <span class="nf">which</span><span class="p">(</span><span class="nf">sapply</span><span class="p">(</span><span class="nf">names</span><span class="p">(</span><span class="nf">coef</span><span class="p">(</span><span class="n">ols</span><span class="p">)),</span> <span class="nf">function</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="nf">grepl</span><span class="p">(</span><span class="s">&quot;w:&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">)))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Retrieve unadjusted p-values and </span>
<span class="n">unadj.p.value</span> <span class="o">&lt;-</span> <span class="n">ols.res</span><span class="p">[</span><span class="n">interact</span><span class="p">,</span> <span class="m">4</span><span class="p">]</span>
<span class="n">adj.p.value</span> <span class="o">&lt;-</span> <span class="nf">p.adjust</span><span class="p">(</span><span class="n">unadj.p.value</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s">&#39;bonferroni&#39;</span><span class="p">)</span>

<span class="nf">data.frame</span><span class="p">(</span><span class="n">estimate</span><span class="o">=</span><span class="nf">coef</span><span class="p">(</span><span class="n">ols</span><span class="p">)[</span><span class="n">interact</span><span class="p">],</span> <span class="n">std.err</span><span class="o">=</span><span class="n">ols.res</span><span class="p">[</span><span class="n">interact</span><span class="p">,</span><span class="m">2</span><span class="p">],</span> <span class="n">unadj.p.value</span><span class="p">,</span> <span class="n">adj.p.value</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table class="dataframe">
<caption>A data.frame: 6 × 4</caption>
<thead>
	<tr><th></th><th scope=col>estimate</th><th scope=col>std.err</th><th scope=col>unadj.p.value</th><th scope=col>adj.p.value</th></tr>
	<tr><th></th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th></tr>
</thead>
<tbody>
	<tr><th scope=row>w:factor(polviews)2</th><td>-0.02424199</td><td>0.02733714</td><td>3.752056e-01</td><td>1.000000e+00</td></tr>
	<tr><th scope=row>w:factor(polviews)3</th><td>-0.05962335</td><td>0.02735735</td><td>2.930808e-02</td><td>1.758485e-01</td></tr>
	<tr><th scope=row>w:factor(polviews)4</th><td>-0.13461439</td><td>0.02534022</td><td>1.090684e-07</td><td>6.544105e-07</td></tr>
	<tr><th scope=row>w:factor(polviews)5</th><td>-0.16491540</td><td>0.02713505</td><td>1.235505e-09</td><td>7.413027e-09</td></tr>
	<tr><th scope=row>w:factor(polviews)6</th><td>-0.18007875</td><td>0.02751422</td><td>6.052625e-11</td><td>3.631575e-10</td></tr>
	<tr><th scope=row>w:factor(polviews)7</th><td>-0.18618443</td><td>0.03870554</td><td>1.514861e-06</td><td>9.089164e-06</td></tr>
</tbody>
</table>
</div></div>
</div>
<p>Another option is to use the <strong>Romano-Wolf</strong> correction, based on <a class="reference external" href="https://www.ssc.wisc.edu/~bhansen/718/RomanoWolf2005.pdf">Romano and Wolf (2005, Econometrica)</a>. This bootstrap-based procedure takes into account the underlying dependence structure of the test statistics in a way that improves power. The Romano-Wolf procedure is correct under minimal assumptions, and should be favored over Bonferroni in general.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Auxiliary function to computes adjusted p-values </span>
<span class="c1"># following the Romano-Wolf method.</span>
<span class="c1"># For a reference, see http://ftp.iza.org/dp12845.pdf page 8</span>
<span class="c1">#  t.orig: vector of t-statistics from original model</span>
<span class="c1">#  t.boot: matrix of t-statistics from bootstrapped models</span>
<span class="n">romano_wolf_correction</span> <span class="o">&lt;-</span> <span class="nf">function</span><span class="p">(</span><span class="n">t.orig</span><span class="p">,</span> <span class="n">t.boot</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">abs.t.orig</span> <span class="o">&lt;-</span> <span class="nf">abs</span><span class="p">(</span><span class="n">t.orig</span><span class="p">)</span>
  <span class="n">abs.t.boot</span> <span class="o">&lt;-</span> <span class="nf">abs</span><span class="p">(</span><span class="n">t.boot</span><span class="p">)</span>
  <span class="n">abs.t.sorted</span> <span class="o">&lt;-</span> <span class="nf">sort</span><span class="p">(</span><span class="n">abs.t.orig</span><span class="p">,</span> <span class="n">decreasing</span> <span class="o">=</span> <span class="kc">TRUE</span><span class="p">)</span>

  <span class="n">max.order</span> <span class="o">&lt;-</span> <span class="nf">order</span><span class="p">(</span><span class="n">abs.t.orig</span><span class="p">,</span> <span class="n">decreasing</span> <span class="o">=</span> <span class="kc">TRUE</span><span class="p">)</span>
  <span class="n">rev.order</span> <span class="o">&lt;-</span> <span class="nf">order</span><span class="p">(</span><span class="n">max.order</span><span class="p">)</span>

  <span class="n">M</span> <span class="o">&lt;-</span> <span class="nf">nrow</span><span class="p">(</span><span class="n">t.boot</span><span class="p">)</span>
  <span class="n">S</span> <span class="o">&lt;-</span> <span class="nf">ncol</span><span class="p">(</span><span class="n">t.boot</span><span class="p">)</span>

  <span class="n">p.adj</span> <span class="o">&lt;-</span> <span class="nf">rep</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">S</span><span class="p">)</span>
  <span class="n">p.adj</span><span class="p">[</span><span class="m">1</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="nf">mean</span><span class="p">(</span><span class="nf">apply</span><span class="p">(</span><span class="n">abs.t.boot</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="n">max</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">abs.t.sorted</span><span class="p">[</span><span class="m">1</span><span class="p">])</span>
  <span class="nf">for </span><span class="p">(</span><span class="n">s</span> <span class="n">in</span> <span class="nf">seq</span><span class="p">(</span><span class="m">2</span><span class="p">,</span> <span class="n">S</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">cur.index</span> <span class="o">&lt;-</span> <span class="n">max.order</span><span class="p">[</span><span class="n">s</span><span class="o">:</span><span class="n">S</span><span class="p">]</span>
    <span class="n">p.init</span> <span class="o">&lt;-</span> <span class="nf">mean</span><span class="p">(</span><span class="nf">apply</span><span class="p">(</span><span class="n">abs.t.boot</span><span class="p">[,</span> <span class="n">cur.index</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">FALSE</span><span class="p">],</span> <span class="m">1</span><span class="p">,</span> <span class="n">max</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">abs.t.sorted</span><span class="p">[</span><span class="n">s</span><span class="p">])</span>
    <span class="n">p.adj</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="nf">max</span><span class="p">(</span><span class="n">p.init</span><span class="p">,</span> <span class="n">p.adj</span><span class="p">[</span><span class="n">s</span><span class="m">-1</span><span class="p">])</span>
  <span class="p">}</span>
  <span class="n">p.adj</span><span class="p">[</span><span class="n">rev.order</span><span class="p">]</span>
<span class="p">}</span>

<span class="c1"># Computes adjusted p-values for linear regression (lm) models.</span>
<span class="c1">#    model: object of lm class (i.e., a linear reg model)</span>
<span class="c1">#    indices: vector of integers for the coefficients that will be tested</span>
<span class="c1">#    cov.type: type of standard error (to be passed to sandwich::vcovHC)</span>
<span class="c1">#    num.boot: number of null bootstrap samples. Increase to stabilize across runs.</span>
<span class="c1"># Note: results are probabilitistic and may change slightly at every run. </span>
<span class="c1">#</span>
<span class="c1"># Adapted from the p_adjust from from the hdm package, written by Philipp Bach.</span>
<span class="c1"># https://github.com/PhilippBach/hdm_prev/blob/master/R/p_adjust.R</span>
<span class="n">summary_rw_lm</span> <span class="o">&lt;-</span> <span class="nf">function</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">indices</span><span class="o">=</span><span class="kc">NULL</span><span class="p">,</span> <span class="n">cov.type</span><span class="o">=</span><span class="s">&quot;HC2&quot;</span><span class="p">,</span> <span class="n">num.boot</span><span class="o">=</span><span class="m">10000</span><span class="p">)</span> <span class="p">{</span>

  <span class="nf">if </span><span class="p">(</span><span class="nf">is.null</span><span class="p">(</span><span class="n">indices</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">indices</span> <span class="o">&lt;-</span> <span class="m">1</span><span class="o">:</span><span class="nf">nrow</span><span class="p">(</span><span class="nf">coef</span><span class="p">(</span><span class="nf">summary</span><span class="p">(</span><span class="n">model</span><span class="p">)))</span>
  <span class="p">}</span>
  <span class="c1"># Grab the original t values.</span>
  <span class="n">summary</span> <span class="o">&lt;-</span> <span class="nf">coef</span><span class="p">(</span><span class="nf">summary</span><span class="p">(</span><span class="n">model</span><span class="p">))[</span><span class="n">indices</span><span class="p">,,</span><span class="n">drop</span><span class="o">=</span><span class="kc">FALSE</span><span class="p">]</span>
  <span class="n">t.orig</span> <span class="o">&lt;-</span> <span class="n">summary</span><span class="p">[,</span> <span class="s">&quot;t value&quot;</span><span class="p">]</span>

  <span class="c1"># Null resampling.</span>
  <span class="c1"># This is a trick to speed up bootstrapping linear models.</span>
  <span class="c1"># Here, we don&#39;t really need to re-fit linear regressions, which would be a bit slow.</span>
  <span class="c1"># We know that betahat ~ N(beta, Sigma), and we have an estimate Sigmahat.</span>
  <span class="c1"># So we can approximate &quot;null t-values&quot; by</span>
  <span class="c1">#  - Draw beta.boot ~ N(0, Sigma-hat) --- note the 0 here, this is what makes it a *null* t-value.</span>
  <span class="c1">#  - Compute t.boot = beta.boot / sqrt(diag(Sigma.hat))</span>
  <span class="n">Sigma.hat</span> <span class="o">&lt;-</span> <span class="nf">vcovHC</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">type</span><span class="o">=</span><span class="n">cov.type</span><span class="p">)[</span><span class="n">indices</span><span class="p">,</span> <span class="n">indices</span><span class="p">]</span>
  <span class="n">se.orig</span> <span class="o">&lt;-</span> <span class="nf">sqrt</span><span class="p">(</span><span class="nf">diag</span><span class="p">(</span><span class="n">Sigma.hat</span><span class="p">))</span>
  <span class="n">num.coef</span> <span class="o">&lt;-</span> <span class="nf">length</span><span class="p">(</span><span class="n">se.orig</span><span class="p">)</span>
  <span class="n">beta.boot</span> <span class="o">&lt;-</span> <span class="nf">mvrnorm</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">num.boot</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="nf">rep</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">num.coef</span><span class="p">),</span> <span class="n">Sigma</span><span class="o">=</span><span class="n">Sigma.hat</span><span class="p">)</span>
  <span class="n">t.boot</span> <span class="o">&lt;-</span> <span class="nf">sweep</span><span class="p">(</span><span class="n">beta.boot</span><span class="p">,</span> <span class="m">2</span><span class="p">,</span> <span class="n">se.orig</span><span class="p">,</span> <span class="s">&quot;/&quot;</span><span class="p">)</span>
  <span class="n">p.adj</span> <span class="o">&lt;-</span> <span class="nf">romano_wolf_correction</span><span class="p">(</span><span class="n">t.orig</span><span class="p">,</span> <span class="n">t.boot</span><span class="p">)</span>

  <span class="n">result</span> <span class="o">&lt;-</span> <span class="nf">cbind</span><span class="p">(</span><span class="n">summary</span><span class="p">[,</span><span class="nf">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="m">2</span><span class="p">,</span><span class="m">4</span><span class="p">),</span><span class="n">drop</span><span class="o">=</span><span class="bp">F</span><span class="p">],</span> <span class="n">p.adj</span><span class="p">)</span>
  <span class="nf">colnames</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">&lt;-</span> <span class="nf">c</span><span class="p">(</span><span class="s">&#39;Estimate&#39;</span><span class="p">,</span> <span class="s">&#39;Std. Error&#39;</span><span class="p">,</span> <span class="s">&#39;Orig. p-value&#39;</span><span class="p">,</span> <span class="s">&#39;Adj. p-value&#39;</span><span class="p">)</span>
  <span class="n">result</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># This linear regression is only valid in a randomized setting.</span>
<span class="n">fmla</span> <span class="o">&lt;-</span> <span class="nf">formula</span><span class="p">(</span><span class="nf">paste</span><span class="p">(</span><span class="n">outcome</span><span class="p">,</span> <span class="s">&#39; ~ &#39;</span><span class="p">,</span> <span class="n">treatment</span><span class="p">,</span> <span class="s">&#39;*&#39;</span><span class="p">,</span> <span class="s">&#39;factor(&#39;</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="s">&#39;)&#39;</span><span class="p">))</span>
<span class="n">ols</span> <span class="o">&lt;-</span> <span class="nf">lm</span><span class="p">(</span><span class="n">fmla</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
<span class="n">interact</span> <span class="o">&lt;-</span> <span class="nf">which</span><span class="p">(</span><span class="nf">sapply</span><span class="p">(</span><span class="nf">names</span><span class="p">(</span><span class="nf">coef</span><span class="p">(</span><span class="n">ols</span><span class="p">)),</span> <span class="nf">function</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="nf">grepl</span><span class="p">(</span><span class="nf">paste0</span><span class="p">(</span><span class="n">treatment</span><span class="p">,</span> <span class="s">&quot;:&quot;</span><span class="p">),</span> <span class="n">x</span><span class="p">)))</span>

<span class="c1"># Applying the romano-wolf correction.</span>
<span class="nf">summary_rw_lm</span><span class="p">(</span><span class="n">ols</span><span class="p">,</span> <span class="n">indices</span><span class="o">=</span><span class="n">interact</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table class="dataframe">
<caption>A matrix: 6 × 4 of type dbl</caption>
<thead>
	<tr><th></th><th scope=col>Estimate</th><th scope=col>Std. Error</th><th scope=col>Orig. p-value</th><th scope=col>Adj. p-value</th></tr>
</thead>
<tbody>
	<tr><th scope=row>w:factor(polviews)2</th><td>-0.02424199</td><td>0.03034779</td><td>4.244098e-01</td><td>0.4181</td></tr>
	<tr><th scope=row>w:factor(polviews)3</th><td>-0.05962335</td><td>0.03015010</td><td>4.798896e-02</td><td>0.0764</td></tr>
	<tr><th scope=row>w:factor(polviews)4</th><td>-0.13461439</td><td>0.02822807</td><td>1.862258e-06</td><td>0.0000</td></tr>
	<tr><th scope=row>w:factor(polviews)5</th><td>-0.16491540</td><td>0.02957511</td><td>2.481093e-08</td><td>0.0000</td></tr>
	<tr><th scope=row>w:factor(polviews)6</th><td>-0.18007875</td><td>0.02966030</td><td>1.284150e-09</td><td>0.0000</td></tr>
	<tr><th scope=row>w:factor(polviews)7</th><td>-0.18618443</td><td>0.03790379</td><td>9.063658e-07</td><td>0.0000</td></tr>
</tbody>
</table>
</div></div>
</div>
<font size=1>
Compare the adjusted p-values under Romano-Wolf with those obtained via Bonferroni above.
</font>
<p>The Bonferroni and Romano-Wolf methods control the <strong>familywise error rate (FWER)</strong>, which is the (asymptotic) probability of rejecting even one true null hypothesis. In other words, for a significance level <span class="math notranslate nohighlight">\(\alpha\)</span>, they guarantee that with probability <span class="math notranslate nohighlight">\(1 - \alpha\)</span> we will make zero false discoveries. However, when the number of hypotheses being tested is very large, this criterion may be so stringent that it prevents us from being able to detect real effects. Instead, there exist alternative procedures that control the (asymptotic) <strong>false discovery rate (FDR)</strong>, defined as the expected proportion of true null hypotheses rejected among all hypotheses rejected. One such procedure is the Benjamini-Hochberg procedure, which is available in base R via <code class="docutils literal notranslate"><span class="pre">p.adjust(...,</span> <span class="pre">method=&quot;BH&quot;)</span></code>. For what remains we’ll stick with FWER control, but keep in mind that FDR control can also useful in exploratory analyses or settings in which there’s a very large number of hypotheses under consideration.</p>
<p>As in the previous chapter, when working with observational data under unconfoundedness and overlap, one can use AIPW scores  <span class="math notranslate nohighlight">\(\hat{\Gamma}_i\)</span> in place of the raw outcomes  <span class="math notranslate nohighlight">\(Y_i\)</span>. In the next snippet, we construct AIPW scores using the <code class="docutils literal notranslate"><span class="pre">causal_forest</span></code> function from the <code class="docutils literal notranslate"><span class="pre">grf</span></code> package.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Valid in randomized settings and observational settings with unconfoundedness+overlap.</span>

<span class="c1"># Preparing data to fit a causal forest</span>
<span class="n">fmla</span> <span class="o">&lt;-</span> <span class="nf">formula</span><span class="p">(</span><span class="nf">paste0</span><span class="p">(</span><span class="s">&quot;~ 0 +&quot;</span><span class="p">,</span> <span class="nf">paste0</span><span class="p">(</span><span class="n">covariates</span><span class="p">,</span> <span class="n">collapse</span><span class="o">=</span><span class="s">&quot;+&quot;</span><span class="p">)))</span>
<span class="n">XX</span> <span class="o">&lt;-</span> <span class="nf">model.matrix</span><span class="p">(</span><span class="n">fmla</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
<span class="n">W</span> <span class="o">&lt;-</span> <span class="n">data</span><span class="p">[,</span><span class="n">treatment</span><span class="p">]</span>
<span class="n">Y</span> <span class="o">&lt;-</span> <span class="n">data</span><span class="p">[,</span><span class="n">outcome</span><span class="p">]</span>

<span class="c1"># Comment or uncomment as appropriate.</span>
<span class="c1"># Randomized setting with known and fixed probabilities (here: 0.5).</span>
<span class="n">forest.tau</span> <span class="o">&lt;-</span> <span class="nf">causal_forest</span><span class="p">(</span><span class="n">XX</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">W</span><span class="p">,</span> <span class="n">W.hat</span><span class="o">=</span><span class="n">.</span><span class="m">5</span><span class="p">)</span> 
<span class="c1"># Observational setting with unconf + overlap, unknown assignment probs.</span>
<span class="n">forest.tau</span> <span class="o">&lt;-</span> <span class="nf">causal_forest</span><span class="p">(</span><span class="n">XX</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">W</span><span class="p">)</span> 

<span class="c1"># Get forest predictions. </span>
<span class="n">tau.hat</span> <span class="o">&lt;-</span> <span class="nf">predict</span><span class="p">(</span><span class="n">forest.tau</span><span class="p">)</span><span class="o">$</span><span class="n">predictions</span> 
<span class="n">m.hat</span> <span class="o">&lt;-</span> <span class="n">forest.tau</span><span class="o">$</span><span class="n">Y.hat</span>  <span class="c1"># E[Y|X] estimates</span>
<span class="n">e.hat</span> <span class="o">&lt;-</span> <span class="n">forest.tau</span><span class="o">$</span><span class="n">W.hat</span>  <span class="c1"># e(X) := E[W|X] estimates (or known quantity)</span>
<span class="n">tau.hat</span> <span class="o">&lt;-</span> <span class="n">forest.tau</span><span class="o">$</span><span class="n">predictions</span>  <span class="c1"># tau(X) estimates</span>
  
<span class="c1"># Predicting mu.hat(X[i], 1) and mu.hat(X[i], 0) for obs in held-out sample</span>
<span class="c1"># Note: to understand this, read equations 6-8 in this vignette</span>
<span class="c1"># https://grf-labs.github.io/grf/articles/muhats.html</span>
<span class="n">mu.hat.0</span> <span class="o">&lt;-</span> <span class="n">m.hat</span> <span class="o">-</span> <span class="n">e.hat</span> <span class="o">*</span> <span class="n">tau.hat</span>        <span class="c1"># E[Y|X,W=0] = E[Y|X] - e(X)*tau(X)</span>
<span class="n">mu.hat.1</span> <span class="o">&lt;-</span> <span class="n">m.hat</span> <span class="o">+</span> <span class="p">(</span><span class="m">1</span> <span class="o">-</span> <span class="n">e.hat</span><span class="p">)</span> <span class="o">*</span> <span class="n">tau.hat</span>  <span class="c1"># E[Y|X,W=1] = E[Y|X] + (1 - e(X))*tau(X)</span>

<span class="c1"># Compute AIPW scores</span>
<span class="n">aipw.scores</span> <span class="o">&lt;-</span> <span class="n">tau.hat</span> <span class="o">+</span> <span class="n">W</span> <span class="o">/</span> <span class="n">e.hat</span> <span class="o">*</span> <span class="p">(</span><span class="n">Y</span> <span class="o">-</span>  <span class="n">mu.hat.1</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="m">1</span> <span class="o">-</span> <span class="n">W</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="m">1</span> <span class="o">-</span> <span class="n">e.hat</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">Y</span> <span class="o">-</span>  <span class="n">mu.hat.0</span><span class="p">)</span>

<span class="c1"># Estimate average treatment effect conditional on group membership</span>
<span class="n">fmla</span> <span class="o">&lt;-</span> <span class="nf">formula</span><span class="p">(</span><span class="nf">paste0</span><span class="p">(</span><span class="s">&#39;aipw.scores ~ factor(&#39;</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="s">&#39;)&#39;</span><span class="p">))</span>
<span class="n">ols</span> <span class="o">&lt;-</span> <span class="nf">lm</span><span class="p">(</span><span class="n">fmla</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="nf">transform</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">aipw.scores</span><span class="o">=</span><span class="n">aipw.scores</span><span class="p">))</span>
<span class="n">ols.res</span> <span class="o">&lt;-</span> <span class="nf">coeftest</span><span class="p">(</span><span class="n">ols</span><span class="p">,</span> <span class="n">vcov</span> <span class="o">=</span> <span class="nf">vcovHC</span><span class="p">(</span><span class="n">ols</span><span class="p">,</span> <span class="s">&quot;HC2&quot;</span><span class="p">))</span>
<span class="n">indices</span> <span class="o">&lt;-</span> <span class="nf">which</span><span class="p">(</span><span class="nf">names</span><span class="p">(</span><span class="nf">coef</span><span class="p">(</span><span class="n">ols.res</span><span class="p">))</span> <span class="o">!=</span> <span class="s">&#39;(Intercept)&#39;</span><span class="p">)</span>
<span class="nf">summary_rw_lm</span><span class="p">(</span><span class="n">ols</span><span class="p">,</span> <span class="n">indices</span><span class="o">=</span><span class="n">indices</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table class="dataframe">
<caption>A matrix: 6 × 4 of type dbl</caption>
<thead>
	<tr><th></th><th scope=col>Estimate</th><th scope=col>Std. Error</th><th scope=col>Orig. p-value</th><th scope=col>Adj. p-value</th></tr>
</thead>
<tbody>
	<tr><th scope=row>factor(polviews)2</th><td>-0.02795025</td><td>0.03214142</td><td>3.845250e-01</td><td>0.3807</td></tr>
	<tr><th scope=row>factor(polviews)3</th><td>-0.07221667</td><td>0.03193727</td><td>2.375413e-02</td><td>0.0363</td></tr>
	<tr><th scope=row>factor(polviews)4</th><td>-0.14091622</td><td>0.02991466</td><td>2.481364e-06</td><td>0.0000</td></tr>
	<tr><th scope=row>factor(polviews)5</th><td>-0.17677722</td><td>0.03133785</td><td>1.706460e-08</td><td>0.0000</td></tr>
	<tr><th scope=row>factor(polviews)6</th><td>-0.18182558</td><td>0.03142800</td><td>7.306397e-09</td><td>0.0000</td></tr>
	<tr><th scope=row>factor(polviews)7</th><td>-0.20309523</td><td>0.04012854</td><td>4.193855e-07</td><td>0.0000</td></tr>
</tbody>
</table>
</div></div>
</div>
<p>One can also construct AIPW scores using any other nonparametric method. Here’s how to do it by fitting flexible generalized linear models <code class="docutils literal notranslate"><span class="pre">glmnet</span></code> and <code class="docutils literal notranslate"><span class="pre">splines</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Valid randomized data and observational data with unconfoundedness+overlap.</span>
<span class="c1"># Note: read the comments below carefully. </span>
<span class="c1"># In randomized settings, do not estimate forest.e and e.hat; use known assignment probs.</span>
<span class="n">fmla.xw</span> <span class="o">&lt;-</span> <span class="nf">formula</span><span class="p">(</span><span class="nf">paste0</span><span class="p">(</span><span class="s">&quot;~&quot;</span><span class="p">,</span> <span class="nf">paste0</span><span class="p">(</span><span class="s">&quot;bs(&quot;</span><span class="p">,</span> <span class="n">covariates</span><span class="p">,</span> <span class="s">&quot;, df=3, degree=3) *&quot;</span><span class="p">,</span> <span class="n">treatment</span><span class="p">,</span> <span class="n">collapse</span><span class="o">=</span><span class="s">&quot;+&quot;</span><span class="p">)))</span>
<span class="n">fmla.x</span> <span class="o">&lt;-</span> <span class="nf">formula</span><span class="p">(</span><span class="nf">paste0</span><span class="p">(</span><span class="s">&quot;~&quot;</span><span class="p">,</span> <span class="nf">paste0</span><span class="p">(</span><span class="s">&quot;bs(&quot;</span><span class="p">,</span> <span class="n">covariates</span><span class="p">,</span> <span class="s">&quot;, df=3, degree=3)&quot;</span><span class="p">,</span> <span class="n">collapse</span><span class="o">=</span><span class="s">&quot;+&quot;</span><span class="p">)))</span>
<span class="n">XW</span> <span class="o">&lt;-</span> <span class="nf">model.matrix</span><span class="p">(</span><span class="n">fmla.xw</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
<span class="n">XX</span> <span class="o">&lt;-</span> <span class="nf">model.matrix</span><span class="p">(</span><span class="n">fmla.x</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
<span class="n">Y</span> <span class="o">&lt;-</span> <span class="n">data</span><span class="p">[,</span><span class="n">outcome</span><span class="p">]</span>

<span class="n">n.folds</span> <span class="o">&lt;-</span> <span class="m">5</span>
<span class="n">indices</span> <span class="o">&lt;-</span> <span class="nf">split</span><span class="p">(</span><span class="nf">seq</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="nf">sort</span><span class="p">(</span><span class="nf">seq</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">%%</span> <span class="n">n.folds</span><span class="p">))</span>

<span class="n">aipw.scores</span> <span class="o">&lt;-</span> <span class="nf">lapply</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="nf">function</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span> <span class="p">{</span>

  <span class="c1"># Fitting the outcome model</span>
  <span class="n">model.m</span> <span class="o">&lt;-</span> <span class="nf">cv.glmnet</span><span class="p">(</span><span class="n">XW</span><span class="p">[</span><span class="o">-</span><span class="n">idx</span><span class="p">,],</span> <span class="n">Y</span><span class="p">[</span><span class="o">-</span><span class="n">idx</span><span class="p">])</span>  
  
  <span class="c1"># Predict outcome E[Y|X,W=w] for w in {0, 1}</span>
  <span class="n">data.0</span> <span class="o">&lt;-</span> <span class="n">data</span>
  <span class="n">data.0</span><span class="p">[,</span><span class="n">treatment</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="m">0</span>
  <span class="n">XW0</span> <span class="o">&lt;-</span> <span class="nf">model.matrix</span><span class="p">(</span><span class="n">fmla.xw</span><span class="p">,</span> <span class="n">data.0</span><span class="p">)</span>
  <span class="n">mu.hat.0</span> <span class="o">&lt;-</span> <span class="nf">predict</span><span class="p">(</span><span class="n">model.m</span><span class="p">,</span> <span class="n">XW0</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="s">&quot;lambda.min&quot;</span><span class="p">)[</span><span class="n">idx</span><span class="p">,]</span>
  
  <span class="n">data.1</span> <span class="o">&lt;-</span> <span class="n">data</span>
  <span class="n">data.1</span><span class="p">[,</span><span class="n">treatment</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="m">1</span>
  <span class="n">XW1</span> <span class="o">&lt;-</span> <span class="nf">model.matrix</span><span class="p">(</span><span class="n">fmla.xw</span><span class="p">,</span> <span class="n">data.1</span><span class="p">)</span>
  <span class="n">mu.hat.1</span> <span class="o">&lt;-</span> <span class="nf">predict</span><span class="p">(</span><span class="n">model.m</span><span class="p">,</span> <span class="n">XW1</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="s">&quot;lambda.min&quot;</span><span class="p">)[</span><span class="n">idx</span><span class="p">,]</span>
  
  <span class="c1"># Fitting the propensity score model</span>
  <span class="c1"># Comment / uncomment the lines below as appropriate.</span>
  <span class="c1"># OBSERVATIONAL SETTING (with unconfoundedness+overlap):</span>
  <span class="c1"># model.e &lt;- cv.glmnet(XX[-idx,], W[-idx], family=&quot;binomial&quot;)  </span>
  <span class="c1"># e.hat &lt;- predict(model.e, XX[idx,], s=&quot;lambda.min&quot;, type=&quot;response&quot;)</span>
  <span class="c1"># RANDOMIZED SETTING</span>
  <span class="n">e.hat</span> <span class="o">&lt;-</span> <span class="nf">rep</span><span class="p">(</span><span class="m">0.5</span><span class="p">,</span> <span class="nf">length</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>  
  
  <span class="c1"># Compute CATE estimates</span>
  <span class="n">tau.hat</span> <span class="o">&lt;-</span> <span class="n">mu.hat.1</span> <span class="o">-</span> <span class="n">mu.hat.0</span>
  
  <span class="c1"># Compute AIPW scores</span>
  <span class="n">aipw.scores</span> <span class="o">&lt;-</span> <span class="p">(</span><span class="n">tau.hat</span> 
                  <span class="o">+</span> <span class="n">W</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">/</span> <span class="n">e.hat</span> <span class="o">*</span> <span class="p">(</span><span class="n">Y</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">-</span>  <span class="n">mu.hat.1</span><span class="p">)</span>
                  <span class="o">-</span> <span class="p">(</span><span class="m">1</span> <span class="o">-</span> <span class="n">W</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="m">1</span> <span class="o">-</span> <span class="n">e.hat</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">Y</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">-</span>  <span class="n">mu.hat.0</span><span class="p">))</span>

  <span class="n">aipw.scores</span>
<span class="p">})</span>
<span class="n">aipw.scores</span><span class="o">&lt;-</span> <span class="nf">unname</span><span class="p">(</span><span class="nf">do.call</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">aipw.scores</span><span class="p">))</span>

<span class="c1"># Estimate average treatment effect conditional on group membership</span>
<span class="n">fmla</span> <span class="o">&lt;-</span> <span class="nf">formula</span><span class="p">(</span><span class="nf">paste0</span><span class="p">(</span><span class="s">&#39;aipw.scores ~ factor(&#39;</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="s">&#39;)&#39;</span><span class="p">))</span>
<span class="n">ols</span> <span class="o">&lt;-</span> <span class="nf">lm</span><span class="p">(</span><span class="n">fmla</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="nf">transform</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">aipw.scores</span><span class="o">=</span><span class="n">aipw.scores</span><span class="p">))</span>
<span class="n">ols.res</span> <span class="o">&lt;-</span> <span class="nf">coeftest</span><span class="p">(</span><span class="n">ols</span><span class="p">,</span> <span class="n">vcov</span> <span class="o">=</span> <span class="nf">vcovHC</span><span class="p">(</span><span class="n">ols</span><span class="p">,</span> <span class="s">&quot;HC2&quot;</span><span class="p">))</span>
<span class="n">indices</span> <span class="o">&lt;-</span> <span class="nf">which</span><span class="p">(</span><span class="nf">names</span><span class="p">(</span><span class="nf">coef</span><span class="p">(</span><span class="n">ols.res</span><span class="p">))</span> <span class="o">!=</span> <span class="s">&#39;(Intercept)&#39;</span><span class="p">)</span>
<span class="nf">summary_rw_lm</span><span class="p">(</span><span class="n">ols</span><span class="p">,</span> <span class="n">indices</span><span class="o">=</span><span class="n">indices</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table class="dataframe">
<caption>A matrix: 6 × 4 of type dbl</caption>
<thead>
	<tr><th></th><th scope=col>Estimate</th><th scope=col>Std. Error</th><th scope=col>Orig. p-value</th><th scope=col>Adj. p-value</th></tr>
</thead>
<tbody>
	<tr><th scope=row>factor(polviews)2</th><td>-0.02431188</td><td>0.03025159</td><td>4.216022e-01</td><td>0.4196</td></tr>
	<tr><th scope=row>factor(polviews)3</th><td>-0.06078026</td><td>0.03005945</td><td>4.318542e-02</td><td>0.0716</td></tr>
	<tr><th scope=row>factor(polviews)4</th><td>-0.13363032</td><td>0.02815576</td><td>2.083662e-06</td><td>0.0000</td></tr>
	<tr><th scope=row>factor(polviews)5</th><td>-0.16498404</td><td>0.02949527</td><td>2.244685e-08</td><td>0.0000</td></tr>
	<tr><th scope=row>factor(polviews)6</th><td>-0.17926620</td><td>0.02958012</td><td>1.375097e-09</td><td>0.0000</td></tr>
	<tr><th scope=row>factor(polviews)7</th><td>-0.18695392</td><td>0.03776909</td><td>7.466598e-07</td><td>0.0000</td></tr>
</tbody>
</table>
</div></div>
</div>
</section>
<section id="data-driven-hypotheses">
<h2><span class="section-number">4.2. </span>Data-driven hypotheses<a class="headerlink" href="#data-driven-hypotheses" title="Permalink to this headline">#</a></h2>
<p>Pre-specifying hypotheses prior to looking at the data is in general good practice to avoid “p-hacking” (e.g., slicing the data into different subgroups until a significant result is found). However, valid tests can also be attained if by <strong>sample splitting</strong>: we can use a subset of the sample to find promising subgroups, then test hypotheses about these subgroups in the remaining sample. This kind of sample splitting for hypothesis testing is called <strong>honesty</strong>.</p>
<section id="via-causal-trees">
<h3><span class="section-number">4.2.1. </span>Via causal trees<a class="headerlink" href="#via-causal-trees" title="Permalink to this headline">#</a></h3>
<p><strong>Causal trees</strong> [(Athey and Imbens)](PNAS, 2016)](<a class="reference external" href="https://www.pnas.org/content/pnas/113/27/7353.full.pdf">https://www.pnas.org/content/pnas/113/27/7353.full.pdf</a>) are an intuitive algorithm that is available in the randomized setting to discover subgroups with different treatment effects.</p>
<p>At a high level, the idea is to divide the sample into three subsets (not necessarily of equal size). The <code class="docutils literal notranslate"><span class="pre">splitting</span></code> subset is used to fit a decision tree whose objective is modified to maximize heterogeneity in treatment effect estimates across leaves. The <code class="docutils literal notranslate"><span class="pre">estimation</span></code> subset is then used to produce a valid estimate of the treatment effect at each leaf of the fitted tree. Finally, a <code class="docutils literal notranslate"><span class="pre">test</span></code> subset can be used to validate the tree estimates.</p>
<p>The next snippet uses <code class="docutils literal notranslate"><span class="pre">honest.causalTree</span></code> function from the <a class="reference external" href="https://github.com/susanathey/causalTree"><code class="docutils literal notranslate"><span class="pre">causalTree</span></code></a> package. For more details, see the <a class="reference external" href="https://github.com/susanathey/causalTree/blob/master/briefintro.pdf">causalTree documentation</a>.</p>
<div class="cell tag_remove_output docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Only valid for randomized data!</span>

<span class="n">fmla</span> <span class="o">&lt;-</span> <span class="nf">paste</span><span class="p">(</span><span class="n">outcome</span><span class="p">,</span> <span class="s">&quot; ~&quot;</span><span class="p">,</span> <span class="nf">paste</span><span class="p">(</span><span class="n">covariates</span><span class="p">,</span> <span class="n">collapse</span> <span class="o">=</span> <span class="s">&quot; + &quot;</span><span class="p">))</span>

<span class="c1"># Dividing data into three subsets</span>
<span class="n">indices</span> <span class="o">&lt;-</span> <span class="nf">split</span><span class="p">(</span><span class="nf">seq</span><span class="p">(</span><span class="nf">nrow</span><span class="p">(</span><span class="n">data</span><span class="p">)),</span> <span class="nf">sort</span><span class="p">(</span><span class="nf">seq</span><span class="p">(</span><span class="nf">nrow</span><span class="p">(</span><span class="n">data</span><span class="p">))</span> <span class="o">%%</span> <span class="m">3</span><span class="p">))</span>
<span class="nf">names</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span> <span class="o">&lt;-</span> <span class="nf">c</span><span class="p">(</span><span class="s">&#39;split&#39;</span><span class="p">,</span> <span class="s">&#39;est&#39;</span><span class="p">,</span> <span class="s">&#39;test&#39;</span><span class="p">)</span>

<span class="c1"># Fitting the forest</span>
<span class="n">ct.unpruned</span> <span class="o">&lt;-</span> <span class="nf">honest.causalTree</span><span class="p">(</span>
  <span class="n">formula</span><span class="o">=</span><span class="n">fmla</span><span class="p">,</span>            <span class="c1"># Define the model</span>
  <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="n">indices</span><span class="o">$</span><span class="n">split</span><span class="p">,],</span>
  <span class="n">treatment</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="n">indices</span><span class="o">$</span><span class="n">split</span><span class="p">,</span> <span class="n">treatment</span><span class="p">],</span>
  <span class="n">est_data</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="n">indices</span><span class="o">$</span><span class="n">est</span><span class="p">,],</span>
  <span class="n">est_treatment</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="n">indices</span><span class="o">$</span><span class="n">est</span><span class="p">,</span> <span class="n">treatment</span><span class="p">],</span>
  <span class="n">minsize</span><span class="o">=</span><span class="m">1</span><span class="p">,</span>                 <span class="c1"># Min. number of treatment and control cases in each leaf</span>
  <span class="n">HonestSampleSize</span><span class="o">=</span><span class="nf">length</span><span class="p">(</span><span class="n">indices</span><span class="o">$</span><span class="n">est</span><span class="p">),</span> <span class="c1">#  Num obs used in estimation after splitting</span>
  <span class="c1"># We recommend not changing the parameters below</span>
  <span class="n">split.Rule</span><span class="o">=</span><span class="s">&quot;CT&quot;</span><span class="p">,</span>            <span class="c1"># Define the splitting option</span>
  <span class="n">cv.option</span><span class="o">=</span><span class="s">&quot;TOT&quot;</span><span class="p">,</span>            <span class="c1"># Cross validation options</span>
  <span class="n">cp</span><span class="o">=</span><span class="m">0</span><span class="p">,</span>                       <span class="c1"># Complexity parameter</span>
  <span class="n">split.Honest</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">,</span>          <span class="c1"># Use honesty when splitting</span>
  <span class="n">cv.Honest</span><span class="o">=</span><span class="kc">TRUE</span>              <span class="c1"># Use honesty when performing cross-validation</span>
<span class="p">)</span>

<span class="c1"># Table of cross-validated values by tuning parameter.</span>
<span class="n">ct.cptable</span> <span class="o">&lt;-</span> <span class="nf">as.data.frame</span><span class="p">(</span><span class="n">ct.unpruned</span><span class="o">$</span><span class="n">cptable</span><span class="p">)</span>

<span class="c1"># Obtain optimal complexity parameter to prune tree.</span>
<span class="n">cp.selected</span> <span class="o">&lt;-</span> <span class="nf">which.min</span><span class="p">(</span><span class="n">ct.cptable</span><span class="o">$</span><span class="n">xerror</span><span class="p">)</span>
<span class="n">cp.optimal</span> <span class="o">&lt;-</span> <span class="n">ct.cptable</span><span class="p">[</span><span class="n">cp.selected</span><span class="p">,</span> <span class="s">&quot;CP&quot;</span><span class="p">]</span>

<span class="c1"># Prune the tree at optimal complexity parameter.</span>
<span class="n">ct.pruned</span> <span class="o">&lt;-</span> <span class="nf">prune</span><span class="p">(</span><span class="n">tree</span><span class="o">=</span><span class="n">ct.unpruned</span><span class="p">,</span> <span class="n">cp</span><span class="o">=</span><span class="n">cp.optimal</span><span class="p">)</span>

<span class="c1"># Predict point estimates (on estimation sample)</span>
<span class="n">tau.hat.est</span> <span class="o">&lt;-</span> <span class="nf">predict</span><span class="p">(</span><span class="n">ct.pruned</span><span class="p">,</span> <span class="n">newdata</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="n">indices</span><span class="o">$</span><span class="n">est</span><span class="p">,])</span>

<span class="c1"># Create a factor column &#39;leaf&#39; indicating leaf assignment in the estimation set</span>
<span class="n">num.leaves</span> <span class="o">&lt;-</span> <span class="nf">length</span><span class="p">(</span><span class="nf">unique</span><span class="p">(</span><span class="n">tau.hat.est</span><span class="p">))</span>
<span class="n">leaf</span> <span class="o">&lt;-</span> <span class="nf">factor</span><span class="p">(</span><span class="n">tau.hat.est</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="nf">sort</span><span class="p">(</span><span class="nf">unique</span><span class="p">(</span><span class="n">tau.hat.est</span><span class="p">)),</span> <span class="n">labels</span> <span class="o">=</span> <span class="nf">seq</span><span class="p">(</span><span class="n">num.leaves</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>Note: if your tree is not splitting at all, try decreasing the parameter <code class="docutils literal notranslate"><span class="pre">minsize</span></code> that controls the minimum size of each leaf. The next snippet plots the learned tree. The values in the cell are the estimated treatment effect and an estimate of the fraction of the population that falls within each leaf. Both are estimated using the <code class="docutils literal notranslate"><span class="pre">estimation</span></code> sample.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">rpart.plot</span><span class="p">(</span>
  <span class="n">x</span><span class="o">=</span><span class="n">ct.pruned</span><span class="p">,</span>        <span class="c1"># Pruned tree</span>
  <span class="n">type</span><span class="o">=</span><span class="m">3</span><span class="p">,</span>             <span class="c1"># Draw separate split labels for the left and right directions</span>
  <span class="n">fallen</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">,</span>        <span class="c1"># Position the leaf nodes at the bottom of the graph</span>
  <span class="n">leaf.round</span><span class="o">=</span><span class="m">1</span><span class="p">,</span>       <span class="c1"># Rounding of the corners of the leaf node boxes</span>
  <span class="n">extra</span><span class="o">=</span><span class="m">100</span><span class="p">,</span>          <span class="c1"># Display the percentage of observations in the node</span>
  <span class="n">branch</span><span class="o">=</span><span class="n">.</span><span class="m">1</span><span class="p">,</span>          <span class="c1"># Shape of the branch lines</span>
  <span class="n">box.palette</span><span class="o">=</span><span class="s">&quot;RdBu&quot;</span><span class="p">)</span> <span class="c1"># Palette for coloring the node</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/4_heterogeneous_treatment_effect_1_24_0.png" src="../_images/4_heterogeneous_treatment_effect_1_24_0.png" />
</div>
</div>
<p>The next snippet tests if the treatment effect in leaves <span class="math notranslate nohighlight">\(\geq 2\)</span> is larger than the treatment effect in the first leaf. The code follows closely what we saw in the previous subsection.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># This is only valid in randomized datasets.</span>
<span class="n">fmla</span> <span class="o">&lt;-</span> <span class="nf">paste0</span><span class="p">(</span><span class="n">outcome</span><span class="p">,</span> <span class="s">&#39; ~ &#39;</span><span class="p">,</span> <span class="nf">paste0</span><span class="p">(</span><span class="n">treatment</span><span class="p">,</span> <span class="s">&#39;* leaf&#39;</span><span class="p">))</span>
<span class="nf">if </span><span class="p">(</span><span class="n">num.leaves</span> <span class="o">==</span> <span class="m">1</span><span class="p">)</span> <span class="p">{</span>
  <span class="nf">print</span><span class="p">(</span><span class="s">&quot;Skipping since there&#39;s a single leaf.&quot;</span><span class="p">)</span>

<span class="p">}</span> <span class="n">else</span> <span class="nf">if </span><span class="p">(</span><span class="n">num.leaves</span> <span class="o">==</span> <span class="m">2</span><span class="p">)</span> <span class="p">{</span>
    
  <span class="c1"># if there are only two leaves, no need to correct for multiple hypotheses</span>
  <span class="n">ols</span> <span class="o">&lt;-</span> <span class="nf">lm</span><span class="p">(</span><span class="n">fmla</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="nf">transform</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">indices</span><span class="o">$</span><span class="n">est</span><span class="p">,],</span> <span class="n">leaf</span><span class="o">=</span><span class="n">leaf</span><span class="p">))</span>
  <span class="nf">coeftest</span><span class="p">(</span><span class="n">ols</span><span class="p">,</span> <span class="n">vcov</span><span class="o">=</span><span class="nf">vcovHC</span><span class="p">(</span><span class="n">ols</span><span class="p">,</span> <span class="s">&#39;HC2&#39;</span><span class="p">))[</span><span class="m">4</span><span class="p">,,</span><span class="n">drop</span><span class="o">=</span><span class="bp">F</span><span class="p">]</span>

<span class="p">}</span> <span class="n">else</span> <span class="p">{</span>
    
  <span class="c1"># if there are three or more leaves, use Romano-Wolf test correction </span>
  <span class="n">ols</span> <span class="o">&lt;-</span> <span class="nf">lm</span><span class="p">(</span><span class="n">fmla</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="nf">transform</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">indices</span><span class="o">$</span><span class="n">est</span><span class="p">,],</span> <span class="n">leaf</span><span class="o">=</span><span class="n">leaf</span><span class="p">))</span>
  <span class="n">interact</span> <span class="o">&lt;-</span> <span class="nf">which</span><span class="p">(</span><span class="nf">sapply</span><span class="p">(</span><span class="nf">names</span><span class="p">(</span><span class="nf">coef</span><span class="p">(</span><span class="n">ols</span><span class="p">)),</span> <span class="nf">function</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="nf">grepl</span><span class="p">(</span><span class="nf">paste0</span><span class="p">(</span><span class="n">treatment</span><span class="p">,</span> <span class="s">&quot;:&quot;</span><span class="p">),</span> <span class="n">x</span><span class="p">)))</span>
  <span class="nf">summary_rw_lm</span><span class="p">(</span><span class="n">ols</span><span class="p">,</span> <span class="n">indices</span><span class="o">=</span><span class="n">interact</span><span class="p">,</span> <span class="n">cov.type</span> <span class="o">=</span> <span class="s">&#39;HC2&#39;</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table class="dataframe">
<caption>A matrix: 8 × 4 of type dbl</caption>
<thead>
	<tr><th></th><th scope=col>Estimate</th><th scope=col>Std. Error</th><th scope=col>Orig. p-value</th><th scope=col>Adj. p-value</th></tr>
</thead>
<tbody>
	<tr><th scope=row>w:leaf2</th><td>0.04261544</td><td>0.02675955</td><td>1.112984e-01</td><td>0.1120</td></tr>
	<tr><th scope=row>w:leaf3</th><td>0.08304080</td><td>0.03903846</td><td>3.343291e-02</td><td>0.0638</td></tr>
	<tr><th scope=row>w:leaf4</th><td>0.08649780</td><td>0.02999722</td><td>3.941285e-03</td><td>0.0125</td></tr>
	<tr><th scope=row>w:leaf5</th><td>0.10688672</td><td>0.03346314</td><td>1.406931e-03</td><td>0.0063</td></tr>
	<tr><th scope=row>w:leaf6</th><td>0.14399896</td><td>0.03708540</td><td>1.039142e-04</td><td>0.0005</td></tr>
	<tr><th scope=row>w:leaf7</th><td>0.17514244</td><td>0.03797784</td><td>4.045881e-06</td><td>0.0000</td></tr>
	<tr><th scope=row>w:leaf8</th><td>0.21914803</td><td>0.04269808</td><td>2.915505e-07</td><td>0.0000</td></tr>
	<tr><th scope=row>w:leaf9</th><td>0.23088896</td><td>0.06627687</td><td>4.967474e-04</td><td>0.0028</td></tr>
</tbody>
</table>
</div></div>
</div>
<p>In the chapter <code class="docutils literal notranslate"><span class="pre">Introduction</span> <span class="pre">to</span> <span class="pre">Machine</span> <span class="pre">Learning</span></code>, we cautioned against interpreting the decision tree splits, and the same is true for causal tree splits. That a tree splits on a particular variable does not mean that this variable is relevant in the underlying data-generating process – it could simply be correlated with some other variable that is. For the same reason, we should not try to interpret <em>partial effects</em> from tree output.</p>
<p>However, similar to what we have done in previous chapters, we can try to understand how the joint distribution of covariates varies for subgroups with different estimated treatment effects. The annotated heatmap below shows the average value of each covariate within each leaf. Leaves are ordered from lowest to highest treatment effect estimate. The color is a normalized distance of each leaf-specific covariate mean from the overall covariate mean, i.e…, <span class="math notranslate nohighlight">\(\smash{\Phi^{-1}\left((\widehat{\text{E}}[X_i|L_i] - \widehat{\text{E}}[X_i])/\widehat{\text{Var}}(\widehat{\text{E}}[X_i|L_i])\right)}\)</span>. The rows are in descending order of variation, measured by <span class="math notranslate nohighlight">\(\widehat{\text{Var}}(\widehat{\text{E}}[X_i|L_i])/\widehat{\text{Var}}(X_i)\)</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">&lt;-</span> <span class="nf">mapply</span><span class="p">(</span><span class="nf">function</span><span class="p">(</span><span class="n">covariate</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1"># Looping over covariate names</span>
      <span class="c1"># Compute average covariate value per leaf (with correct standard errors)</span>
      <span class="n">fmla</span> <span class="o">&lt;-</span> <span class="nf">formula</span><span class="p">(</span><span class="nf">paste0</span><span class="p">(</span><span class="n">covariate</span><span class="p">,</span> <span class="s">&quot;~ 0 + leaf&quot;</span><span class="p">))</span>
      <span class="n">ols</span> <span class="o">&lt;-</span> <span class="nf">lm</span><span class="p">(</span><span class="n">fmla</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="nf">transform</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">indices</span><span class="o">$</span><span class="n">est</span><span class="p">,],</span> <span class="n">leaf</span><span class="o">=</span><span class="n">leaf</span><span class="p">))</span>
      <span class="n">ols.res</span> <span class="o">&lt;-</span> <span class="nf">coeftest</span><span class="p">(</span><span class="n">ols</span><span class="p">,</span> <span class="n">vcov</span><span class="o">=</span><span class="nf">vcovHC</span><span class="p">(</span><span class="n">ols</span><span class="p">,</span> <span class="s">&quot;HC2&quot;</span><span class="p">))</span>
    
      <span class="c1"># Retrieve results</span>
      <span class="n">avg</span> <span class="o">&lt;-</span> <span class="n">ols.res</span><span class="p">[,</span><span class="m">1</span><span class="p">]</span>
      <span class="n">stderr</span> <span class="o">&lt;-</span> <span class="n">ols.res</span><span class="p">[,</span><span class="m">2</span><span class="p">]</span>
      
      <span class="c1"># Tally up results</span>
      <span class="nf">data.frame</span><span class="p">(</span><span class="n">covariate</span><span class="p">,</span> <span class="n">avg</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">leaf</span><span class="o">=</span><span class="nf">paste0</span><span class="p">(</span><span class="s">&quot;Leaf&quot;</span><span class="p">,</span> <span class="nf">seq</span><span class="p">(</span><span class="n">num.leaves</span><span class="p">)),</span> 
                 <span class="c1"># Used for coloring</span>
                 <span class="n">scaling</span><span class="o">=</span><span class="nf">pnorm</span><span class="p">((</span><span class="n">avg</span> <span class="o">-</span> <span class="nf">mean</span><span class="p">(</span><span class="n">avg</span><span class="p">))</span><span class="o">/</span><span class="nf">sd</span><span class="p">(</span><span class="n">avg</span><span class="p">)),</span> 
                 <span class="c1"># We will order based on how much variation is &#39;explain&#39; by the averages</span>
                 <span class="c1"># relative to the total variation of the covariate in the data</span>
                 <span class="n">variation</span><span class="o">=</span><span class="nf">sd</span><span class="p">(</span><span class="n">avg</span><span class="p">)</span> <span class="o">/</span> <span class="nf">sd</span><span class="p">(</span><span class="n">data</span><span class="p">[,</span><span class="n">covariate</span><span class="p">]),</span>
                 <span class="c1"># String to print in each cell in heatmap below</span>
                 <span class="n">labels</span><span class="o">=</span><span class="nf">paste0</span><span class="p">(</span><span class="nf">signif</span><span class="p">(</span><span class="n">avg</span><span class="p">,</span> <span class="m">3</span><span class="p">),</span> <span class="s">&quot;\n&quot;</span><span class="p">,</span> <span class="s">&quot;(&quot;</span><span class="p">,</span> <span class="nf">signif</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="m">3</span><span class="p">),</span> <span class="s">&quot;)&quot;</span><span class="p">))</span>
<span class="p">},</span> <span class="n">covariates</span><span class="p">,</span> <span class="n">SIMPLIFY</span> <span class="o">=</span> <span class="kc">FALSE</span><span class="p">)</span>
<span class="n">df</span> <span class="o">&lt;-</span> <span class="nf">do.call</span><span class="p">(</span><span class="n">rbind</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span>

<span class="c1"># a small optional trick to ensure heatmap will be in decreasing order of &#39;variation&#39;</span>
<span class="n">df</span><span class="o">$</span><span class="n">covariate</span> <span class="o">&lt;-</span> <span class="nf">reorder</span><span class="p">(</span><span class="n">df</span><span class="o">$</span><span class="n">covariate</span><span class="p">,</span> <span class="nf">order</span><span class="p">(</span><span class="n">df</span><span class="o">$</span><span class="n">variation</span><span class="p">))</span>

<span class="c1"># plot heatmap</span>
<span class="nf">ggplot</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">+</span>
    <span class="nf">aes</span><span class="p">(</span><span class="n">leaf</span><span class="p">,</span> <span class="n">covariate</span><span class="p">)</span> <span class="o">+</span>
    <span class="nf">geom_tile</span><span class="p">(</span><span class="nf">aes</span><span class="p">(</span><span class="n">fill</span> <span class="o">=</span> <span class="n">scaling</span><span class="p">))</span> <span class="o">+</span> 
    <span class="nf">geom_text</span><span class="p">(</span><span class="nf">aes</span><span class="p">(</span><span class="n">label</span> <span class="o">=</span> <span class="n">labels</span><span class="p">))</span> <span class="o">+</span>
    <span class="nf">scale_fill_gradient</span><span class="p">(</span><span class="n">low</span> <span class="o">=</span> <span class="s">&quot;#E1BE6A&quot;</span><span class="p">,</span> <span class="n">high</span> <span class="o">=</span> <span class="s">&quot;#40B0A6&quot;</span><span class="p">)</span> <span class="o">+</span>
    <span class="nf">ggtitle</span><span class="p">(</span><span class="nf">paste0</span><span class="p">(</span><span class="s">&quot;Average covariate values within each leaf&quot;</span><span class="p">))</span> <span class="o">+</span>
    <span class="nf">theme_minimal</span><span class="p">()</span> <span class="o">+</span> 
    <span class="nf">ylab</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="nf">xlab</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">)</span> <span class="o">+</span>
    <span class="nf">theme</span><span class="p">(</span><span class="n">plot.title</span> <span class="o">=</span> <span class="nf">element_text</span><span class="p">(</span><span class="n">size</span> <span class="o">=</span> <span class="m">12</span><span class="p">,</span> <span class="n">face</span> <span class="o">=</span> <span class="s">&quot;bold&quot;</span><span class="p">),</span>
          <span class="n">axis.text</span><span class="o">=</span><span class="nf">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="m">11</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/4_heterogeneous_treatment_effect_1_28_0.png" src="../_images/4_heterogeneous_treatment_effect_1_28_0.png" />
</div>
</div>
<font size=1>
Interpret the heatmap above. What describes the subgroups with strongest and weakest estimated treatment effect?
</font></section>
<section id="via-grf">
<h3><span class="section-number">4.2.2. </span>Via grf<a class="headerlink" href="#via-grf" title="Permalink to this headline">#</a></h3>
<p>The function <code class="docutils literal notranslate"><span class="pre">causal_forest</span></code> from the package <code class="docutils literal notranslate"><span class="pre">grf</span></code> allows us to get estimates of the CATE  (4.1).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get predictions from forest fitted above.</span>
<span class="n">tau.hat</span> <span class="o">&lt;-</span> <span class="nf">predict</span><span class="p">(</span><span class="n">forest.tau</span><span class="p">)</span><span class="o">$</span><span class="n">predictions</span>  <span class="c1"># tau(X) estimates</span>
</pre></div>
</div>
</div>
</div>
<p>Having fit a non-parametric method such as a causal forest, a researcher may (incorrectly) start by looking at the distribution of its predictions of the treatment effect. One might be tempted to think: “if the histogram is concentrated at a point, then there is no heterogeneity; if the histogram is spread out, then our estimator has found interesting heterogeneity.” However, this may be false.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Do not use this for assessing heterogeneity. See text above.</span>
<span class="nf">hist</span><span class="p">(</span><span class="n">tau.hat</span><span class="p">,</span> <span class="n">main</span><span class="o">=</span><span class="s">&quot;CATE estimates&quot;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="bp">F</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/4_heterogeneous_treatment_effect_1_33_0.png" src="../_images/4_heterogeneous_treatment_effect_1_33_0.png" />
</div>
</div>
<p>If the histogram is concentrated at a point, we may simply be underpowered: our method was not able to detect any heterogeneity, but maybe it would detect it if we had more data. If the histogram is spread out, we may be overfitting: our model is producing very noisy estimates <span class="math notranslate nohighlight">\(\widehat{\tau}(x)\)</span>, but in fact the true  <span class="math notranslate nohighlight">\(\tau(x)\)</span> can be much smoother as a function of <span class="math notranslate nohighlight">\(x\)</span>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">grf</span></code> package also produces a measure of variable importance that indicates how often a variable was used in a tree split. Again, much like the histogram above, this can be a rough diagnostic, but it should not be interpreted as indicating that, for example, variable with low importance is not related to heterogeneity. The reasoning is the same as the one presented in the causal trees section: if two covariates are highly correlated, the trees might split on one covariate but not the other, even though both (or maybe neither) are relevant in the true data-generating process.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">var_imp</span> <span class="o">&lt;-</span> <span class="nf">c</span><span class="p">(</span><span class="nf">variable_importance</span><span class="p">(</span><span class="n">forest.tau</span><span class="p">))</span>
<span class="nf">names</span><span class="p">(</span><span class="n">var_imp</span><span class="p">)</span> <span class="o">&lt;-</span> <span class="n">covariates</span>
<span class="n">sorted_var_imp</span> <span class="o">&lt;-</span> <span class="nf">sort</span><span class="p">(</span><span class="n">var_imp</span><span class="p">,</span> <span class="n">decreasing</span> <span class="o">=</span> <span class="kc">TRUE</span><span class="p">)</span>
<span class="n">sorted_var_imp</span><span class="p">[</span><span class="m">1</span><span class="o">:</span><span class="m">5</span><span class="p">]</span>  <span class="c1"># showing only first few</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style>
.dl-inline {width: auto; margin:0; padding: 0}
.dl-inline>dt, .dl-inline>dd {float: none; width: auto; display: inline-block}
.dl-inline>dt::after {content: ":\0020"; padding-right: .5ex}
.dl-inline>dt:not(:first-of-type) {padding-left: .5ex}
</style><dl class=dl-inline><dt>polviews</dt><dd>0.433258607483693</dd><dt>income</dt><dd>0.344211697930238</dd><dt>age</dt><dd>0.0960133851852657</dd><dt>educ</dt><dd>0.076559323995593</dd><dt>marital</dt><dd>0.0433236777217158</dd></dl>
</div></div>
</div>
<section id="data-driven-subgroups">
<h4><span class="section-number">4.2.2.1. </span>Data-driven subgroups<a class="headerlink" href="#data-driven-subgroups" title="Permalink to this headline">#</a></h4>
<p>Just as with causal trees, we can use causal forests to divide our observations into subgroups. In place of leaves, we’ll rank observation into (say) quintiles according to their estimated CATE prediction; see, e.g., <a class="reference external" href="https://arxiv.org/abs/1712.04802">Chernozhukov, Demirer, Duflo, Fernández-Val (2020)</a> for similar ideas.</p>
<p>There’s a subtle but important point that needs to be addressed here. As we have mentioned before, when predicting the conditional average treatment effect <span class="math notranslate nohighlight">\(\hat{\tau}(X_i)\)</span> for observation <span class="math notranslate nohighlight">\(i\)</span> we should in general avoid using a model that was fitted using observation <span class="math notranslate nohighlight">\(i\)</span>. This sort of sample splitting (which we called <strong>honesty</strong> above) is one of the required ingredients to get unbiased estimates of the CATE using the methods described here. However, when ranking estimates of two observations <span class="math notranslate nohighlight">\(i\)</span> and <span class="math notranslate nohighlight">\(j\)</span>, we need something a little stronger: we must ensure that the model was not fit using <em>either</em> <span class="math notranslate nohighlight">\(i\)</span> <em>or</em> <span class="math notranslate nohighlight">\(j\)</span>’s data.</p>
<p>One way of overcoming this obstacle is simple. First, divide the data into <span class="math notranslate nohighlight">\(K\)</span> folds (subsets). Then, cycle through the folds, fitting a CATE model on <span class="math notranslate nohighlight">\(K-1\)</span> folds. Next, for each held-out fold, <em>separately</em> rank the unseen observations into <span class="math notranslate nohighlight">\(Q\)</span> groups based on their prediction  (i.e., if <span class="math notranslate nohighlight">\(Q=5\)</span>, then we rank observations by estimated CATE into “top quintile”, “second quintile”, and so on). After concatenating the independent rankings together, we can study the differences in observations in each rank-group.</p>
<p><a class="reference external" href="https://gist.github.com/halflearned/bea4e5137c0c81fd18a75f682da466c8">This gist</a> computes the above for <code class="docutils literal notranslate"><span class="pre">grf</span></code>, and it should not be hard to modify it so as to replace forests by any other non-parametric method. However, for <code class="docutils literal notranslate"><span class="pre">grf</span></code> specifically, there’s a small trick that allows us to obtain a valid ranking: we can pass a vector of fold indices to the argument <code class="docutils literal notranslate"><span class="pre">clusters</span></code> and rank observations within each fold. This works because estimates for each fold (“cluster”)   trees are computed using trees that were not fit using observations from that fold. Here’s how to do it.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Valid randomized data and observational data with unconfoundedness+overlap.</span>
<span class="c1"># Note: read the comments below carefully. </span>
<span class="c1"># In randomized settings, do not estimate forest.e and e.hat; use known assignment probs.</span>

<span class="c1"># Prepare dataset</span>
<span class="n">fmla</span> <span class="o">&lt;-</span> <span class="nf">formula</span><span class="p">(</span><span class="nf">paste0</span><span class="p">(</span><span class="s">&quot;~ 0 + &quot;</span><span class="p">,</span> <span class="nf">paste0</span><span class="p">(</span><span class="n">covariates</span><span class="p">,</span> <span class="n">collapse</span><span class="o">=</span><span class="s">&quot;+&quot;</span><span class="p">)))</span>
<span class="n">X</span> <span class="o">&lt;-</span> <span class="nf">model.matrix</span><span class="p">(</span><span class="n">fmla</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
<span class="n">W</span> <span class="o">&lt;-</span> <span class="n">data</span><span class="p">[,</span><span class="n">treatment</span><span class="p">]</span>
<span class="n">Y</span> <span class="o">&lt;-</span> <span class="n">data</span><span class="p">[,</span><span class="n">outcome</span><span class="p">]</span>

<span class="c1"># Number of rankings that the predictions will be ranking on </span>
<span class="c1"># (e.g., 2 for above/below median estimated CATE, 5 for estimated CATE quintiles, etc.)</span>
<span class="n">num.rankings</span> <span class="o">&lt;-</span> <span class="m">5</span>  

<span class="c1"># Prepare for data.splitting</span>
<span class="c1"># Assign a fold number to each observation.</span>
<span class="c1"># The argument &#39;clusters&#39; in the next step will mimick K-fold cross-fitting.</span>
<span class="n">num.folds</span> <span class="o">&lt;-</span> <span class="m">10</span>
<span class="n">folds</span> <span class="o">&lt;-</span> <span class="nf">sort</span><span class="p">(</span><span class="nf">seq</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">%%</span> <span class="n">num.folds</span><span class="p">)</span> <span class="o">+</span> <span class="m">1</span>

<span class="c1"># Comment or uncomment depending on your setting.</span>
<span class="c1"># Observational setting with unconfoundedness+overlap (unknown assignment probs):</span>
<span class="c1"># forest &lt;- causal_forest(X, Y, W, clusters = folds)</span>
<span class="c1"># Randomized settings with fixed and known probabilities (here: 0.5).</span>
<span class="n">forest</span> <span class="o">&lt;-</span> <span class="nf">causal_forest</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">W</span><span class="p">,</span> <span class="n">W.hat</span><span class="o">=</span><span class="n">.</span><span class="m">5</span><span class="p">,</span> <span class="n">clusters</span> <span class="o">=</span> <span class="n">folds</span><span class="p">)</span>

<span class="c1"># Retrieve out-of-bag predictions.</span>
<span class="c1"># Predictions for observation in fold k will be computed using </span>
<span class="c1"># trees that were not trained using observations for that fold.</span>
<span class="n">tau.hat</span> <span class="o">&lt;-</span> <span class="nf">predict</span><span class="p">(</span><span class="n">forest</span><span class="p">)</span><span class="o">$</span><span class="n">predictions</span>

<span class="c1"># Rank observations *within each fold* into quintiles according to their CATE predictions.</span>
<span class="n">ranking</span> <span class="o">&lt;-</span> <span class="nf">rep</span><span class="p">(</span><span class="kc">NA</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
<span class="nf">for </span><span class="p">(</span><span class="n">fold</span> <span class="n">in</span> <span class="nf">seq</span><span class="p">(</span><span class="n">num.folds</span><span class="p">))</span> <span class="p">{</span>
  <span class="n">tau.hat.quantiles</span> <span class="o">&lt;-</span> <span class="nf">quantile</span><span class="p">(</span><span class="n">tau.hat</span><span class="p">[</span><span class="n">folds</span> <span class="o">==</span> <span class="n">fold</span><span class="p">],</span> <span class="n">probs</span> <span class="o">=</span> <span class="nf">seq</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="n">by</span><span class="o">=</span><span class="m">1</span><span class="o">/</span><span class="n">num.rankings</span><span class="p">))</span>
  <span class="n">ranking</span><span class="p">[</span><span class="n">folds</span> <span class="o">==</span> <span class="n">fold</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="nf">cut</span><span class="p">(</span><span class="n">tau.hat</span><span class="p">[</span><span class="n">folds</span> <span class="o">==</span> <span class="n">fold</span><span class="p">],</span> <span class="n">tau.hat.quantiles</span><span class="p">,</span> <span class="n">include.lowest</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">,</span><span class="n">labels</span><span class="o">=</span><span class="nf">seq</span><span class="p">(</span><span class="n">num.rankings</span><span class="p">))</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<p>The next snippet computes the average treatment effect within each group defined above, i.e., <span class="math notranslate nohighlight">\(\mathbf{E}[Y_i(1) - Y_i(0)|G_i = g]\)</span>. This can done in two ways. First, by computing a simple difference-in-means estimate of the ATE based on observations within each group. This is valid only in randomized settings.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Valid only in randomized settings.</span>
<span class="c1"># Average difference-in-means within each ranking</span>

<span class="c1"># Formula y ~ 0 + ranking + ranking:w</span>
<span class="n">fmla</span> <span class="o">&lt;-</span> <span class="nf">paste0</span><span class="p">(</span><span class="n">outcome</span><span class="p">,</span> <span class="s">&quot; ~ 0 + ranking + ranking:&quot;</span><span class="p">,</span> <span class="n">treatment</span><span class="p">)</span>
<span class="n">ols.ate</span> <span class="o">&lt;-</span> <span class="nf">lm</span><span class="p">(</span><span class="n">fmla</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="nf">transform</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ranking</span><span class="o">=</span><span class="nf">factor</span><span class="p">(</span><span class="n">ranking</span><span class="p">)))</span>
<span class="n">ols.ate</span> <span class="o">&lt;-</span> <span class="nf">coeftest</span><span class="p">(</span><span class="n">ols.ate</span><span class="p">,</span> <span class="n">vcov</span><span class="o">=</span><span class="nf">vcovHC</span><span class="p">(</span><span class="n">ols.ate</span><span class="p">,</span> <span class="n">type</span><span class="o">=</span><span class="s">&#39;HC2&#39;</span><span class="p">))</span>
<span class="n">interact</span> <span class="o">&lt;-</span> <span class="nf">which</span><span class="p">(</span><span class="nf">grepl</span><span class="p">(</span><span class="s">&quot;:&quot;</span><span class="p">,</span> <span class="nf">rownames</span><span class="p">(</span><span class="n">ols.ate</span><span class="p">)))</span>
<span class="n">ols.ate</span> <span class="o">&lt;-</span> <span class="nf">data.frame</span><span class="p">(</span><span class="s">&quot;ols&quot;</span><span class="p">,</span> <span class="nf">paste0</span><span class="p">(</span><span class="s">&quot;Q&quot;</span><span class="p">,</span> <span class="nf">seq</span><span class="p">(</span><span class="n">num.rankings</span><span class="p">)),</span> <span class="n">ols.ate</span><span class="p">[</span><span class="n">interact</span><span class="p">,</span> <span class="m">1</span><span class="o">:</span><span class="m">2</span><span class="p">])</span>
<span class="nf">rownames</span><span class="p">(</span><span class="n">ols.ate</span><span class="p">)</span> <span class="o">&lt;-</span> <span class="kc">NULL</span> <span class="c1"># just for display</span>
<span class="nf">colnames</span><span class="p">(</span><span class="n">ols.ate</span><span class="p">)</span> <span class="o">&lt;-</span> <span class="nf">c</span><span class="p">(</span><span class="s">&quot;method&quot;</span><span class="p">,</span> <span class="s">&quot;ranking&quot;</span><span class="p">,</span> <span class="s">&quot;estimate&quot;</span><span class="p">,</span> <span class="s">&quot;std.err&quot;</span><span class="p">)</span>
<span class="n">ols.ate</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table class="dataframe">
<caption>A data.frame: 5 × 4</caption>
<thead>
	<tr><th scope=col>method</th><th scope=col>ranking</th><th scope=col>estimate</th><th scope=col>std.err</th></tr>
	<tr><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th></tr>
</thead>
<tbody>
	<tr><td>ols</td><td>Q1</td><td>-0.4378371</td><td>0.011335456</td></tr>
	<tr><td>ols</td><td>Q2</td><td>-0.3927502</td><td>0.011154697</td></tr>
	<tr><td>ols</td><td>Q3</td><td>-0.3626420</td><td>0.011070478</td></tr>
	<tr><td>ols</td><td>Q4</td><td>-0.3350308</td><td>0.010466097</td></tr>
	<tr><td>ols</td><td>Q5</td><td>-0.2093947</td><td>0.009779184</td></tr>
</tbody>
</table>
</div></div>
</div>
<p>Another option is to average the AIPW scores within each group. This valid for both randomized settings and observational settings with unconfoundedness and overlap. Moreover, AIPW-based estimators should produce estimates with tighter confidence intervals in large samples.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Computing AIPW scores.</span>
<span class="n">tau.hat</span> <span class="o">&lt;-</span> <span class="nf">predict</span><span class="p">(</span><span class="n">forest</span><span class="p">)</span><span class="o">$</span><span class="n">predictions</span>
<span class="n">e.hat</span> <span class="o">&lt;-</span> <span class="n">forest</span><span class="o">$</span><span class="n">W.hat</span> <span class="c1"># P[W=1|X]</span>
<span class="n">m.hat</span> <span class="o">&lt;-</span> <span class="n">forest</span><span class="o">$</span><span class="n">Y.hat</span> <span class="c1"># E[Y|X]</span>

<span class="c1"># Estimating mu.hat(X, 1) and mu.hat(X, 0) for obs in held-out sample</span>
<span class="c1"># Note: to understand this, read equations 6-8 in this vignette:</span>
<span class="c1"># https://grf-labs.github.io/grf/articles/muhats.html</span>
<span class="n">mu.hat.0</span> <span class="o">&lt;-</span> <span class="n">m.hat</span> <span class="o">-</span> <span class="n">e.hat</span> <span class="o">*</span> <span class="n">tau.hat</span>        <span class="c1"># E[Y|X,W=0] = E[Y|X] - e(X)*tau(X)</span>
<span class="n">mu.hat.1</span> <span class="o">&lt;-</span> <span class="n">m.hat</span> <span class="o">+</span> <span class="p">(</span><span class="m">1</span> <span class="o">-</span> <span class="n">e.hat</span><span class="p">)</span> <span class="o">*</span> <span class="n">tau.hat</span>  <span class="c1"># E[Y|X,W=1] = E[Y|X] + (1 - e(X))*tau(X)</span>

<span class="c1"># AIPW scores</span>
<span class="n">aipw.scores</span> <span class="o">&lt;-</span> <span class="n">tau.hat</span> <span class="o">+</span> <span class="n">W</span> <span class="o">/</span> <span class="n">e.hat</span> <span class="o">*</span> <span class="p">(</span><span class="n">Y</span> <span class="o">-</span>  <span class="n">mu.hat.1</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="m">1</span> <span class="o">-</span> <span class="n">W</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="m">1</span> <span class="o">-</span> <span class="n">e.hat</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">Y</span> <span class="o">-</span>  <span class="n">mu.hat.0</span><span class="p">)</span>
<span class="n">ols</span> <span class="o">&lt;-</span> <span class="nf">lm</span><span class="p">(</span><span class="n">aipw.scores</span> <span class="o">~</span> <span class="m">0</span> <span class="o">+</span> <span class="nf">factor</span><span class="p">(</span><span class="n">ranking</span><span class="p">))</span>
<span class="n">forest.ate</span> <span class="o">&lt;-</span> <span class="nf">data.frame</span><span class="p">(</span><span class="s">&quot;aipw&quot;</span><span class="p">,</span> <span class="nf">paste0</span><span class="p">(</span><span class="s">&quot;Q&quot;</span><span class="p">,</span> <span class="nf">seq</span><span class="p">(</span><span class="n">num.rankings</span><span class="p">)),</span> <span class="nf">coeftest</span><span class="p">(</span><span class="n">ols</span><span class="p">,</span> <span class="n">vcov</span><span class="o">=</span><span class="nf">vcovHC</span><span class="p">(</span><span class="n">ols</span><span class="p">,</span> <span class="s">&quot;HC2&quot;</span><span class="p">))[,</span><span class="m">1</span><span class="o">:</span><span class="m">2</span><span class="p">])</span>
<span class="nf">colnames</span><span class="p">(</span><span class="n">forest.ate</span><span class="p">)</span> <span class="o">&lt;-</span> <span class="nf">c</span><span class="p">(</span><span class="s">&quot;method&quot;</span><span class="p">,</span> <span class="s">&quot;ranking&quot;</span><span class="p">,</span> <span class="s">&quot;estimate&quot;</span><span class="p">,</span> <span class="s">&quot;std.err&quot;</span><span class="p">)</span>
<span class="nf">rownames</span><span class="p">(</span><span class="n">forest.ate</span><span class="p">)</span> <span class="o">&lt;-</span> <span class="kc">NULL</span> <span class="c1"># just for display</span>
<span class="n">forest.ate</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table class="dataframe">
<caption>A data.frame: 5 × 4</caption>
<thead>
	<tr><th scope=col>method</th><th scope=col>ranking</th><th scope=col>estimate</th><th scope=col>std.err</th></tr>
	<tr><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th></tr>
</thead>
<tbody>
	<tr><td>aipw</td><td>Q1</td><td>-0.4390673</td><td>0.011020933</td></tr>
	<tr><td>aipw</td><td>Q2</td><td>-0.3922020</td><td>0.010799775</td></tr>
	<tr><td>aipw</td><td>Q3</td><td>-0.3618846</td><td>0.010620071</td></tr>
	<tr><td>aipw</td><td>Q4</td><td>-0.3352387</td><td>0.010190596</td></tr>
	<tr><td>aipw</td><td>Q5</td><td>-0.2061308</td><td>0.009324303</td></tr>
</tbody>
</table>
</div></div>
</div>
<p>The code below plots the estimates.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Concatenate the two results.</span>
<span class="n">res</span> <span class="o">&lt;-</span> <span class="nf">rbind</span><span class="p">(</span><span class="n">forest.ate</span><span class="p">,</span> <span class="n">ols.ate</span><span class="p">)</span>

<span class="c1"># Plotting the point estimate of average treatment effect </span>
<span class="c1"># and 95% confidence intervals around it.</span>
<span class="nf">ggplot</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">+</span>
  <span class="nf">aes</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">ranking</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">estimate</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">method</span><span class="p">)</span> <span class="o">+</span> 
  <span class="nf">geom_point</span><span class="p">(</span><span class="n">position</span><span class="o">=</span><span class="nf">position_dodge</span><span class="p">(</span><span class="m">0.2</span><span class="p">))</span> <span class="o">+</span>
  <span class="nf">geom_errorbar</span><span class="p">(</span><span class="nf">aes</span><span class="p">(</span><span class="n">ymin</span><span class="o">=</span><span class="n">estimate</span><span class="m">-2</span><span class="o">*</span><span class="n">std.err</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="n">estimate</span><span class="m">+2</span><span class="o">*</span><span class="n">std.err</span><span class="p">),</span> <span class="n">width</span><span class="o">=</span><span class="n">.</span><span class="m">2</span><span class="p">,</span> <span class="n">position</span><span class="o">=</span><span class="nf">position_dodge</span><span class="p">(</span><span class="m">0.2</span><span class="p">))</span> <span class="o">+</span>
  <span class="nf">ylab</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="nf">xlab</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">)</span> <span class="o">+</span>
  <span class="nf">ggtitle</span><span class="p">(</span><span class="s">&quot;Average CATE within each ranking (as defined by predicted CATE)&quot;</span><span class="p">)</span> <span class="o">+</span>
  <span class="nf">theme_minimal</span><span class="p">()</span> <span class="o">+</span>
  <span class="nf">theme</span><span class="p">(</span><span class="n">legend.position</span><span class="o">=</span><span class="s">&quot;bottom&quot;</span><span class="p">,</span> <span class="n">legend.title</span> <span class="o">=</span> <span class="nf">element_blank</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/4_heterogeneous_treatment_effect_1_43_0.png" src="../_images/4_heterogeneous_treatment_effect_1_43_0.png" />
</div>
</div>
<p>When there isn’t much detectable heterogeneity, the plot above can end up being non-monotonic. This can mean that the number of observations is too small for us to be able to detect subgroups with relevant differences in treatment effect.</p>
<font size=1>
As an exercise, try running the previous two snippets on few data points (e.g., the first thousand observations only). You will likely see the "non-monotonicity" phenomenon just described.
</font>
<p>Next, as we did for leaves in a causal tree, we can test e.g., if the prediction for groups 2, 3, etc. are larger than the one in the first group. Here’s how to do it based on a difference-in-means estimator. Note the Romano-Wolf multiple-hypothesis testing correction.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Valid in randomized settings only.</span>

<span class="c1"># y ~ ranking + w + ranking:w</span>
<span class="n">fmla</span> <span class="o">&lt;-</span> <span class="nf">paste0</span><span class="p">(</span><span class="n">outcome</span><span class="p">,</span> <span class="s">&quot;~ ranking + &quot;</span><span class="p">,</span> <span class="n">treatment</span><span class="p">,</span> <span class="s">&quot; + ranking:&quot;</span><span class="p">,</span> <span class="n">treatment</span><span class="p">)</span> 
<span class="n">ols</span> <span class="o">&lt;-</span> <span class="nf">lm</span><span class="p">(</span><span class="n">fmla</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="nf">transform</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ranking</span><span class="o">=</span><span class="nf">factor</span><span class="p">(</span><span class="n">ranking</span><span class="p">)))</span>
<span class="n">interact</span> <span class="o">&lt;-</span> <span class="nf">which</span><span class="p">(</span><span class="nf">sapply</span><span class="p">(</span><span class="nf">names</span><span class="p">(</span><span class="nf">coef</span><span class="p">(</span><span class="n">ols</span><span class="p">)),</span> <span class="nf">function</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="nf">grepl</span><span class="p">(</span><span class="s">&quot;:&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">)))</span>
<span class="n">res</span> <span class="o">&lt;-</span> <span class="nf">summary_rw_lm</span><span class="p">(</span><span class="n">ols</span><span class="p">,</span> <span class="n">indices</span><span class="o">=</span><span class="n">interact</span><span class="p">)</span>
<span class="nf">rownames</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">&lt;-</span> <span class="nf">paste</span><span class="p">(</span><span class="s">&quot;Rank&quot;</span><span class="p">,</span> <span class="m">2</span><span class="o">:</span><span class="n">num.rankings</span><span class="p">,</span> <span class="s">&quot;- Rank 1&quot;</span><span class="p">)</span> <span class="c1"># just for display</span>
<span class="n">res</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table class="dataframe">
<caption>A matrix: 4 × 4 of type dbl</caption>
<thead>
	<tr><th></th><th scope=col>Estimate</th><th scope=col>Std. Error</th><th scope=col>Orig. p-value</th><th scope=col>Adj. p-value</th></tr>
</thead>
<tbody>
	<tr><th scope=row>Rank 2 - Rank 1</th><td>0.04508695</td><td>0.01475419</td><td>2.246112e-03</td><td>0.0026</td></tr>
	<tr><th scope=row>Rank 3 - Rank 1</th><td>0.07519511</td><td>0.01475453</td><td>3.483542e-07</td><td>0.0000</td></tr>
	<tr><th scope=row>Rank 4 - Rank 1</th><td>0.10280633</td><td>0.01473954</td><td>3.128080e-12</td><td>0.0000</td></tr>
	<tr><th scope=row>Rank 5 - Rank 1</th><td>0.22844237</td><td>0.01475404</td><td>7.429110e-54</td><td>0.0000</td></tr>
</tbody>
</table>
</div></div>
</div>
<p>Here’s how to do it for AIPW-based estimates, again with Romano-Wolf correction for multiple hypothesis testing.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Valid in randomized and observational settings with unconfoundedness+overlap.</span>

<span class="c1"># Using AIPW scores computed above</span>
<span class="n">ols</span> <span class="o">&lt;-</span> <span class="nf">lm</span><span class="p">(</span><span class="n">aipw.scores</span> <span class="o">~</span> <span class="m">1</span> <span class="o">+</span> <span class="nf">factor</span><span class="p">(</span><span class="n">ranking</span><span class="p">))</span>
<span class="n">res</span> <span class="o">&lt;-</span> <span class="nf">summary_rw_lm</span><span class="p">(</span><span class="n">ols</span><span class="p">,</span> <span class="n">indices</span><span class="o">=</span><span class="m">2</span><span class="o">:</span><span class="n">num.rankings</span><span class="p">)</span>
<span class="nf">rownames</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">&lt;-</span> <span class="nf">paste</span><span class="p">(</span><span class="s">&quot;Rank&quot;</span><span class="p">,</span> <span class="m">2</span><span class="o">:</span><span class="n">num.rankings</span><span class="p">,</span> <span class="s">&quot;- Rank 1&quot;</span><span class="p">)</span> <span class="c1"># just for display</span>
<span class="n">res</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table class="dataframe">
<caption>A matrix: 4 × 4 of type dbl</caption>
<thead>
	<tr><th></th><th scope=col>Estimate</th><th scope=col>Std. Error</th><th scope=col>Orig. p-value</th><th scope=col>Adj. p-value</th></tr>
</thead>
<tbody>
	<tr><th scope=row>Rank 2 - Rank 1</th><td>0.04686534</td><td>0.01471836</td><td>1.453393e-03</td><td>0.0017</td></tr>
	<tr><th scope=row>Rank 3 - Rank 1</th><td>0.07718279</td><td>0.01471579</td><td>1.574795e-07</td><td>0.0000</td></tr>
	<tr><th scope=row>Rank 4 - Rank 1</th><td>0.10382860</td><td>0.01471707</td><td>1.765498e-12</td><td>0.0000</td></tr>
	<tr><th scope=row>Rank 5 - Rank 1</th><td>0.23293656</td><td>0.01471707</td><td>3.472807e-56</td><td>0.0000</td></tr>
</tbody>
</table>
</div></div>
</div>
<p>Finally, we can also check if different groups have different average covariate levels across rankings.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">&lt;-</span> <span class="nf">mapply</span><span class="p">(</span><span class="nf">function</span><span class="p">(</span><span class="n">covariate</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1"># Looping over covariate names</span>
      <span class="c1"># Compute average covariate value per ranking (with correct standard errors)</span>
      <span class="n">fmla</span> <span class="o">&lt;-</span> <span class="nf">formula</span><span class="p">(</span><span class="nf">paste0</span><span class="p">(</span><span class="n">covariate</span><span class="p">,</span> <span class="s">&quot;~ 0 + ranking&quot;</span><span class="p">))</span>
      <span class="n">ols</span> <span class="o">&lt;-</span> <span class="nf">lm</span><span class="p">(</span><span class="n">fmla</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="nf">transform</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ranking</span><span class="o">=</span><span class="nf">factor</span><span class="p">(</span><span class="n">ranking</span><span class="p">)))</span>
      <span class="n">ols.res</span> <span class="o">&lt;-</span> <span class="nf">coeftest</span><span class="p">(</span><span class="n">ols</span><span class="p">,</span> <span class="n">vcov</span><span class="o">=</span><span class="nf">vcovHC</span><span class="p">(</span><span class="n">ols</span><span class="p">,</span> <span class="s">&quot;HC2&quot;</span><span class="p">))</span>
    
      <span class="c1"># Retrieve results</span>
      <span class="n">avg</span> <span class="o">&lt;-</span> <span class="n">ols.res</span><span class="p">[,</span><span class="m">1</span><span class="p">]</span>
      <span class="n">stderr</span> <span class="o">&lt;-</span> <span class="n">ols.res</span><span class="p">[,</span><span class="m">2</span><span class="p">]</span>
      
      <span class="c1"># Tally up results</span>
      <span class="nf">data.frame</span><span class="p">(</span><span class="n">covariate</span><span class="p">,</span> <span class="n">avg</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span> <span class="n">ranking</span><span class="o">=</span><span class="nf">paste0</span><span class="p">(</span><span class="s">&quot;Q&quot;</span><span class="p">,</span> <span class="nf">seq</span><span class="p">(</span><span class="n">num.rankings</span><span class="p">)),</span> 
                 <span class="c1"># Used for coloring</span>
                 <span class="n">scaling</span><span class="o">=</span><span class="nf">pnorm</span><span class="p">((</span><span class="n">avg</span> <span class="o">-</span> <span class="nf">mean</span><span class="p">(</span><span class="n">avg</span><span class="p">))</span><span class="o">/</span><span class="nf">sd</span><span class="p">(</span><span class="n">avg</span><span class="p">)),</span> 
                 <span class="c1"># We will order based on how much variation is &#39;explain&#39; by the averages</span>
                 <span class="c1"># relative to the total variation of the covariate in the data</span>
                 <span class="n">variation</span><span class="o">=</span><span class="nf">sd</span><span class="p">(</span><span class="n">avg</span><span class="p">)</span> <span class="o">/</span> <span class="nf">sd</span><span class="p">(</span><span class="n">data</span><span class="p">[,</span><span class="n">covariate</span><span class="p">]),</span>
                 <span class="c1"># String to print in each cell in heatmap below</span>
                 <span class="n">labels</span><span class="o">=</span><span class="nf">paste0</span><span class="p">(</span><span class="nf">signif</span><span class="p">(</span><span class="n">avg</span><span class="p">,</span> <span class="m">3</span><span class="p">),</span> <span class="s">&quot;\n&quot;</span><span class="p">,</span> <span class="s">&quot;(&quot;</span><span class="p">,</span> <span class="nf">signif</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="m">3</span><span class="p">),</span> <span class="s">&quot;)&quot;</span><span class="p">))</span>
<span class="p">},</span> <span class="n">covariates</span><span class="p">,</span> <span class="n">SIMPLIFY</span> <span class="o">=</span> <span class="kc">FALSE</span><span class="p">)</span>
<span class="n">df</span> <span class="o">&lt;-</span> <span class="nf">do.call</span><span class="p">(</span><span class="n">rbind</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span>

<span class="c1"># a small optional trick to ensure heatmap will be in decreasing order of &#39;variation&#39;</span>
<span class="n">df</span><span class="o">$</span><span class="n">covariate</span> <span class="o">&lt;-</span> <span class="nf">reorder</span><span class="p">(</span><span class="n">df</span><span class="o">$</span><span class="n">covariate</span><span class="p">,</span> <span class="nf">order</span><span class="p">(</span><span class="n">df</span><span class="o">$</span><span class="n">variation</span><span class="p">))</span>

<span class="c1"># plot heatmap</span>
<span class="nf">ggplot</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">+</span>
    <span class="nf">aes</span><span class="p">(</span><span class="n">ranking</span><span class="p">,</span> <span class="n">covariate</span><span class="p">)</span> <span class="o">+</span>
    <span class="nf">geom_tile</span><span class="p">(</span><span class="nf">aes</span><span class="p">(</span><span class="n">fill</span> <span class="o">=</span> <span class="n">scaling</span><span class="p">))</span> <span class="o">+</span> 
    <span class="nf">geom_text</span><span class="p">(</span><span class="nf">aes</span><span class="p">(</span><span class="n">label</span> <span class="o">=</span> <span class="n">labels</span><span class="p">))</span> <span class="o">+</span>
    <span class="nf">scale_fill_gradient</span><span class="p">(</span><span class="n">low</span> <span class="o">=</span> <span class="s">&quot;#E1BE6A&quot;</span><span class="p">,</span> <span class="n">high</span> <span class="o">=</span> <span class="s">&quot;#40B0A6&quot;</span><span class="p">)</span> <span class="o">+</span>
    <span class="nf">ggtitle</span><span class="p">(</span><span class="nf">paste0</span><span class="p">(</span><span class="s">&quot;Average covariate values within group (based on CATE estimate ranking)&quot;</span><span class="p">))</span> <span class="o">+</span>
    <span class="nf">theme_minimal</span><span class="p">()</span> <span class="o">+</span> 
    <span class="nf">ylab</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="nf">xlab</span><span class="p">(</span><span class="s">&quot;CATE estimate ranking&quot;</span><span class="p">)</span> <span class="o">+</span>
    <span class="nf">theme</span><span class="p">(</span><span class="n">plot.title</span> <span class="o">=</span> <span class="nf">element_text</span><span class="p">(</span><span class="n">size</span> <span class="o">=</span> <span class="m">11</span><span class="p">,</span> <span class="n">face</span> <span class="o">=</span> <span class="s">&quot;bold&quot;</span><span class="p">),</span>
          <span class="n">axis.text</span><span class="o">=</span><span class="nf">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="m">11</span><span class="p">))</span> 
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/4_heterogeneous_treatment_effect_1_49_0.png" src="../_images/4_heterogeneous_treatment_effect_1_49_0.png" />
</div>
</div>
<font size=1>
Interpret the heatmap above. What describes the subgroups with strongest and weakest estimated treatment effect? Are there variables that seem to increase or decrease monotonically across rankings?
</font></section>
<section id="best-linear-projection">
<h4><span class="section-number">4.2.2.2. </span>Best linear projection<a class="headerlink" href="#best-linear-projection" title="Permalink to this headline">#</a></h4>
<p>This function provides a doubly robust fit to the linear model <span class="math notranslate nohighlight">\(\widehat{\tau}(X_i) = \beta_0 + A_i'\beta_1\)</span>, where <span class="math notranslate nohighlight">\(A_i\)</span> can be a subset of the covariate columns. The coefficients in this regression are suggestive of general trends, but they should not be interpret as partial effects – that would only be true if the true model were really linear in covariates, and that’s an assumption we shouldn’t be willing to make in general.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Best linear projection of the conditional average treatment effect on covariates</span>
<span class="nf">best_linear_projection</span><span class="p">(</span><span class="n">forest.tau</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Best linear projection of the conditional average treatment effect.
Confidence intervals are cluster- and heteroskedasticity-robust (HC3):

               Estimate  Std. Error  t value  Pr(&gt;|t|)    
(Intercept) -0.18082010  0.04240123  -4.2645 2.010e-05 ***
age          0.00150263  0.00031089   4.8334 1.349e-06 ***
polviews    -0.03575570  0.00356697 -10.0241 &lt; 2.2e-16 ***
income      -0.02087075  0.00201707 -10.3471 &lt; 2.2e-16 ***
educ         0.00897050  0.00172512   5.1999 2.007e-07 ***
marital      0.01055778  0.00331723   3.1827  0.001461 ** 
sex         -0.00650588  0.01000440  -0.6503  0.515503    
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
</pre></div>
</div>
</div>
</div>
</section>
<section id="assessing-heterogeneity">
<h4><span class="section-number">4.2.2.3. </span>Assessing heterogeneity<a class="headerlink" href="#assessing-heterogeneity" title="Permalink to this headline">#</a></h4>
<p>The function <code class="docutils literal notranslate"><span class="pre">test_calibration</span></code> computes an estimate of the best linear predictor of true CATE based on out-of-bag predictions <span class="math notranslate nohighlight">\(\hat{\tau}^{-i}(\cdot)\)</span>. The exact implementation seeks to fit the following linear model:</p>
<div class="amsmath math notranslate nohighlight" id="equation-d52b758b-a3e6-4bf9-8fdc-d00fd78c097e">
<span class="eqno">(4.7)<a class="headerlink" href="#equation-d52b758b-a3e6-4bf9-8fdc-d00fd78c097e" title="Permalink to this equation">#</a></span>\[\begin{equation}
Y_{i} - \hat{m}^{-i}(X_{i}) = \alpha\bar{\tau}\left(W_{i} - \hat{e}^{-i}(X_{i})\right) + \beta \left(\hat{\tau}^{-i}(X_{i}) - \bar{\tau} \right) \left(W_{i} - \hat{e}^{-i}(X_{i}) \right) + \epsilon,
\end{equation}\]</div>
<p>where <span class="math notranslate nohighlight">\(\bar{\tau} := n^{-1}\sum_{i=1}^{n} \hat{\tau}^{-i}(X_{i})\)</span>. The coefficients <span class="math notranslate nohighlight">\(\alpha\)</span> and <span class="math notranslate nohighlight">\(\beta\)</span> allow us to evaluate the performance of our estimates. If <span class="math notranslate nohighlight">\(\alpha = 1\)</span>, then the average prediction produced by the forest is correct. Meanwhile, if <span class="math notranslate nohighlight">\(\beta = 1\)</span>, then the forest predictions adequately capture the underlying heterogeneity.</p>
<p>The slope <span class="math notranslate nohighlight">\(\beta\)</span> is a measure of how the CATE predictions covary with true CATE. Therefore, the p-value on the estimate of coefficient also acts as an omnibus test for the presence of heterogeneity. If the coefficient is significantly greater than zero, then we can reject the null of no heterogeneity. However, coefficients smaller than 0 are not meaningful and show not be interpreted.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">test_calibration</span><span class="p">(</span><span class="n">forest.tau</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Best linear fit using forest predictions (on held-out data)
as well as the mean forest prediction as regressors, along
with one-sided heteroskedasticity-robust (HC3) SEs:

                               Estimate Std. Error t value    Pr(&gt;t)    
mean.forest.prediction         1.000353   0.013716  72.932 &lt; 2.2e-16 ***
differential.forest.prediction 0.904588   0.048086  18.812 &lt; 2.2e-16 ***
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
</pre></div>
</div>
</div>
</div>
<font size=1>
Interpret the test above. Is the forest producing correct estimate of the average treatment effect? Is it capturing the underlying heterogeneity?
</font></section>
<section id="partial-dependence">
<h4><span class="section-number">4.2.2.4. </span>Partial dependence<a class="headerlink" href="#partial-dependence" title="Permalink to this headline">#</a></h4>
<p>It may also be interesting to examine how our CATE estimates behave when we change a single covariate, while keeping all the other covariates at a some fixed value. In the plot below we evaluate a variable of interest across quantiles, while keeping all other covariates at their median.</p>
<p>It is important to recognize that by keeping some variables at their median we may be evaluating the CATE at <span class="math notranslate nohighlight">\(x\)</span> values in regions where there are few or no data points. Also, it may be the case that varying some particular variable while keeping others fixed may just not be very interesting.</p>
<p>In what follows we’ll again use <code class="docutils literal notranslate"><span class="pre">causal_forest</span></code> predictions, along with their variance estimates (set <code class="docutils literal notranslate"><span class="pre">estimate.variances=TRUE</span></code> when predicting to we get estimates of the asymptotic variance of the prediction for each point). Since <code class="docutils literal notranslate"><span class="pre">grf</span></code> predictions are asymptotically normal, we can construct 95% confidence intervals in the usual manner (i.e., <span class="math notranslate nohighlight">\(\hat{\tau}(x) \pm 1.96\sqrt{\widehat{\text{Var}}(\hat{\tau}(x))}\)</span>).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">selected.covariate</span> <span class="o">&lt;-</span> <span class="s">&quot;polviews&quot;</span>
<span class="n">other.covariates</span> <span class="o">&lt;-</span> <span class="n">covariates</span><span class="p">[</span><span class="nf">which</span><span class="p">(</span><span class="n">covariates</span> <span class="o">!=</span> <span class="n">selected.covariate</span><span class="p">)]</span>

<span class="c1"># Fitting a forest </span>
<span class="c1"># (commented for convenience; no need re-fit if already fitted above)</span>
<span class="n">fmla</span> <span class="o">&lt;-</span> <span class="nf">formula</span><span class="p">(</span><span class="nf">paste0</span><span class="p">(</span><span class="s">&quot;~ 0 + &quot;</span><span class="p">,</span> <span class="nf">paste0</span><span class="p">(</span><span class="n">covariates</span><span class="p">,</span> <span class="n">collapse</span><span class="o">=</span><span class="s">&quot;+&quot;</span><span class="p">)))</span>
<span class="c1"># Note: For smaller confidence intervals, set num.trees ~ sample size</span>
<span class="c1"># X &lt;- model.matrix(fmla, data)</span>
<span class="c1"># W &lt;- data[,treatment]</span>
<span class="c1"># Y &lt;- data[,outcome]</span>
<span class="c1"># forest.tau &lt;- causal_forest(X, Y, W, W.hat=.5)  # few trees for speed here</span>

<span class="c1"># Compute a grid of values appropriate for the selected covariate</span>
<span class="n">grid.size</span> <span class="o">&lt;-</span> <span class="m">7</span> 
<span class="n">covariate.grid</span> <span class="o">&lt;-</span> <span class="nf">seq</span><span class="p">(</span><span class="nf">min</span><span class="p">(</span><span class="n">data</span><span class="p">[,</span><span class="n">selected.covariate</span><span class="p">]),</span> <span class="nf">max</span><span class="p">(</span><span class="n">data</span><span class="p">[,</span><span class="n">selected.covariate</span><span class="p">]),</span> <span class="n">length.out</span><span class="o">=</span><span class="n">grid.size</span><span class="p">)</span>

<span class="c1"># Other options for constructing a grid:</span>
<span class="c1"># For a binary variable, simply use 0 and 1</span>
<span class="c1"># grid.size &lt;- 2</span>
<span class="c1"># covariate.grid &lt;- c(0, 1)  </span>

<span class="c1"># For a continuous variable, select appropriate percentiles</span>
<span class="c1"># percentiles &lt;- c(.1, .25, .5, .75, .9)</span>
<span class="c1"># grid.size &lt;- length(percentiles)</span>
<span class="c1"># covariate.grid &lt;- quantile(data[,selected.covariate], probs=percentiles)</span>

<span class="c1"># Take median of other covariates </span>
<span class="n">medians</span> <span class="o">&lt;-</span> <span class="nf">apply</span><span class="p">(</span><span class="n">data</span><span class="p">[,</span> <span class="n">other.covariates</span><span class="p">,</span> <span class="bp">F</span><span class="p">],</span> <span class="m">2</span><span class="p">,</span> <span class="n">median</span><span class="p">)</span>

<span class="c1"># Construct a dataset</span>
<span class="n">data.grid</span> <span class="o">&lt;-</span> <span class="nf">data.frame</span><span class="p">(</span><span class="nf">sapply</span><span class="p">(</span><span class="n">medians</span><span class="p">,</span> <span class="nf">function</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="nf">rep</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">grid.size</span><span class="p">)),</span> <span class="n">covariate.grid</span><span class="p">)</span>
<span class="nf">colnames</span><span class="p">(</span><span class="n">data.grid</span><span class="p">)</span> <span class="o">&lt;-</span> <span class="nf">c</span><span class="p">(</span><span class="n">other.covariates</span><span class="p">,</span> <span class="n">selected.covariate</span><span class="p">)</span>

<span class="c1"># Expand the data</span>
<span class="n">X.grid</span> <span class="o">&lt;-</span> <span class="nf">model.matrix</span><span class="p">(</span><span class="n">fmla</span><span class="p">,</span> <span class="n">data.grid</span><span class="p">)</span>

<span class="c1"># Point predictions of the CATE and standard errors </span>
<span class="n">forest.pred</span> <span class="o">&lt;-</span> <span class="nf">predict</span><span class="p">(</span><span class="n">forest.tau</span><span class="p">,</span> <span class="n">newdata</span> <span class="o">=</span> <span class="n">X.grid</span><span class="p">,</span> <span class="n">estimate.variance</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">)</span>
<span class="n">tau.hat</span> <span class="o">&lt;-</span> <span class="n">forest.pred</span><span class="o">$</span><span class="n">predictions</span>
<span class="n">tau.hat.se</span> <span class="o">&lt;-</span> <span class="nf">sqrt</span><span class="p">(</span><span class="n">forest.pred</span><span class="o">$</span><span class="n">variance.estimates</span><span class="p">)</span>

<span class="c1"># Plot predictions for each group and 95% confidence intervals around them.</span>
<span class="n">data.pred</span> <span class="o">&lt;-</span> <span class="nf">transform</span><span class="p">(</span><span class="n">data.grid</span><span class="p">,</span> <span class="n">tau.hat</span><span class="o">=</span><span class="n">tau.hat</span><span class="p">,</span> <span class="n">ci.low</span> <span class="o">=</span> <span class="n">tau.hat</span> <span class="o">-</span> <span class="m">2</span><span class="o">*</span><span class="n">tau.hat.se</span><span class="p">,</span> <span class="n">ci.high</span> <span class="o">=</span> <span class="n">tau.hat</span> <span class="o">+</span> <span class="m">2</span><span class="o">*</span><span class="n">tau.hat.se</span><span class="p">)</span>
<span class="nf">ggplot</span><span class="p">(</span><span class="n">data.pred</span><span class="p">)</span> <span class="o">+</span>
  <span class="nf">geom_line</span><span class="p">(</span><span class="nf">aes_string</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">selected.covariate</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s">&quot;tau.hat&quot;</span><span class="p">,</span> <span class="n">group</span> <span class="o">=</span> <span class="m">1</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s">&quot;black&quot;</span><span class="p">)</span> <span class="o">+</span>
  <span class="nf">geom_errorbar</span><span class="p">(</span><span class="nf">aes_string</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">selected.covariate</span><span class="p">,</span> <span class="n">ymin</span><span class="o">=</span><span class="s">&quot;ci.low&quot;</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="s">&quot;ci.high&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">.</span><span class="m">2</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s">&quot;blue&quot;</span><span class="p">)</span> <span class="o">+</span>
   <span class="nf">ylab</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">)</span> <span class="o">+</span>
  <span class="nf">ggtitle</span><span class="p">(</span><span class="nf">paste0</span><span class="p">(</span><span class="s">&quot;Predicted treatment effect varying &#39;&quot;</span><span class="p">,</span> <span class="n">selected.covariate</span><span class="p">,</span> <span class="s">&quot;&#39; (other variables fixed at median)&quot;</span><span class="p">))</span> <span class="o">+</span>
  <span class="nf">scale_x_continuous</span><span class="p">(</span><span class="s">&quot;polviews&quot;</span><span class="p">,</span> <span class="n">breaks</span><span class="o">=</span><span class="n">covariate.grid</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="nf">signif</span><span class="p">(</span><span class="n">covariate.grid</span><span class="p">,</span> <span class="m">2</span><span class="p">))</span> <span class="o">+</span>
  <span class="nf">theme_minimal</span><span class="p">()</span> <span class="o">+</span>
  <span class="nf">theme</span><span class="p">(</span><span class="n">plot.title</span> <span class="o">=</span> <span class="nf">element_text</span><span class="p">(</span><span class="n">size</span> <span class="o">=</span> <span class="m">11</span><span class="p">,</span> <span class="n">face</span> <span class="o">=</span> <span class="s">&quot;bold&quot;</span><span class="p">))</span> <span class="o">+</span> <span class="nf">geom_hline</span><span class="p">(</span><span class="n">yintercept</span><span class="o">=</span><span class="m">0</span><span class="p">,</span> <span class="n">linetype</span><span class="o">=</span><span class="s">&quot;dashed&quot;</span><span class="p">,</span> 
                <span class="n">color</span> <span class="o">=</span> <span class="s">&quot;black&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="m">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/4_heterogeneous_treatment_effect_1_57_0.png" src="../_images/4_heterogeneous_treatment_effect_1_57_0.png" />
</div>
</div>
<p>Note that, in this example, we got fairly large confidence intervals. This can be explained in two ways. First, as we mentioned above, there’s a data scarcity problem. For example, even though the number of observations with <code class="docutils literal notranslate"><span class="pre">polviews</span></code> equal to <code class="docutils literal notranslate"><span class="pre">6</span></code> is not small,</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">with</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nf">mean</span><span class="p">(</span><span class="n">polviews</span> <span class="o">==</span> <span class="m">6</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">0.154538791749555</div></div>
</div>
<p>there’s a much smaller fraction of individuals with <code class="docutils literal notranslate"><span class="pre">polviews</span></code> equal to <code class="docutils literal notranslate"><span class="pre">6</span></code> and (say) age close to the median age,</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">mean</span><span class="p">(</span><span class="nf">with</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="n">polviews</span> <span class="o">==</span> <span class="m">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="nf">abs</span><span class="p">(</span><span class="n">age</span> <span class="o">-</span> <span class="nf">median</span><span class="p">(</span><span class="n">age</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="m">3</span><span class="p">)))</span> <span class="c1"># at most 3 yrs away</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">0.0224758315010645</div></div>
</div>
<p>and an even smaller fraction of observations with <code class="docutils literal notranslate"><span class="pre">polviews</span></code> equal to <code class="docutils literal notranslate"><span class="pre">6</span></code> and every other variable close to the median. The second cause of wide confidence intervals is statistical. Since <code class="docutils literal notranslate"><span class="pre">grf</span></code> is a non-parametric model, we should expect fairly wide confidence intervals, especially in high-dimensional problems – that is an unavoidable consequence of avoiding modeling assumptions.</p>
<p>As documented in the original paper on generalized random forests <a class="reference external" href="https://arxiv.org/abs/1610.01271">Athey, Tibshirani and Wager, 2019</a>, the coverage of <code class="docutils literal notranslate"><span class="pre">grf</span></code> confidence intervals can drop if the signal is too dense or too complex relative to the number of observations. Also, to a point, it’s possible to get tighter confidence intervals by increasing the number of trees; see this <a class="reference external" href="https://grf-labs.github.io/grf/articles/ci_and_num.trees.html">short vignette</a> for more information.</p>
<p>We can vary more than one variable at a time. The next snippet shows predictions and standard errors varying two variables.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">x1</span> <span class="o">&lt;-</span> <span class="s">&#39;polviews&#39;</span>
<span class="n">x2</span> <span class="o">&lt;-</span> <span class="s">&#39;age&#39;</span>
<span class="n">selected.covariates</span> <span class="o">&lt;-</span> <span class="nf">c</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">)</span>
<span class="n">other.covariates</span> <span class="o">&lt;-</span> <span class="n">covariates</span><span class="p">[</span><span class="o">-</span><span class="nf">which</span><span class="p">(</span><span class="n">covariates</span> <span class="o">%in%</span> <span class="n">selected.covariates</span><span class="p">)]</span>

<span class="c1"># Compute a grid of values appropriate for the selected covariate</span>
<span class="c1"># See other options for constructing grids in the snippet above.</span>
<span class="n">x1.grid.size</span> <span class="o">&lt;-</span> <span class="m">7</span>
<span class="n">x2.grid.size</span> <span class="o">&lt;-</span> <span class="m">5</span>
<span class="n">x1.grid</span> <span class="o">&lt;-</span> <span class="nf">seq</span><span class="p">(</span><span class="nf">min</span><span class="p">(</span><span class="n">data</span><span class="p">[,</span><span class="n">x1</span><span class="p">]),</span> <span class="nf">max</span><span class="p">(</span><span class="n">data</span><span class="p">[,</span><span class="n">x1</span><span class="p">]),</span> <span class="n">length.out</span><span class="o">=</span><span class="n">x1.grid.size</span><span class="p">)</span>
<span class="n">x2.grid</span> <span class="o">&lt;-</span> <span class="nf">seq</span><span class="p">(</span><span class="nf">min</span><span class="p">(</span><span class="n">data</span><span class="p">[,</span><span class="n">x2</span><span class="p">]),</span> <span class="nf">max</span><span class="p">(</span><span class="n">data</span><span class="p">[,</span><span class="n">x2</span><span class="p">]),</span> <span class="n">length.out</span><span class="o">=</span><span class="n">x2.grid.size</span><span class="p">)</span>

<span class="c1"># Take median of other covariates </span>
<span class="n">medians</span> <span class="o">&lt;-</span> <span class="nf">apply</span><span class="p">(</span><span class="n">data</span><span class="p">[,</span> <span class="n">other.covariates</span><span class="p">,</span> <span class="bp">F</span><span class="p">],</span> <span class="m">2</span><span class="p">,</span> <span class="n">median</span><span class="p">)</span>

<span class="c1"># Construct dataset</span>
<span class="n">data.grid</span> <span class="o">&lt;-</span> <span class="nf">data.frame</span><span class="p">(</span>
                <span class="nf">sapply</span><span class="p">(</span><span class="n">medians</span><span class="p">,</span> <span class="nf">function</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="nf">rep</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">grid.size</span><span class="p">)),</span> 
                <span class="nf">expand.grid</span><span class="p">(</span><span class="n">x1.grid</span><span class="p">,</span> <span class="n">x2.grid</span><span class="p">))</span>
<span class="nf">colnames</span><span class="p">(</span><span class="n">data.grid</span><span class="p">)</span> <span class="o">&lt;-</span> <span class="nf">c</span><span class="p">(</span><span class="n">other.covariates</span><span class="p">,</span> <span class="n">selected.covariates</span><span class="p">)</span>

<span class="c1"># Expand the data according to formula used to fit forest</span>
<span class="n">X.grid</span> <span class="o">&lt;-</span> <span class="nf">model.matrix</span><span class="p">(</span><span class="n">fmla</span><span class="p">,</span> <span class="n">data.grid</span><span class="p">)</span>

<span class="c1"># Forest-based point estimates of CATE and standard errors around them</span>
<span class="n">forest.pred</span> <span class="o">&lt;-</span> <span class="nf">predict</span><span class="p">(</span><span class="n">forest.tau</span><span class="p">,</span> <span class="n">newdata</span> <span class="o">=</span> <span class="n">X.grid</span><span class="p">,</span> <span class="n">estimate.variance</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">)</span>
<span class="n">tau.hat</span> <span class="o">&lt;-</span> <span class="n">forest.pred</span><span class="o">$</span><span class="n">predictions</span>
<span class="n">tau.hat.se</span> <span class="o">&lt;-</span> <span class="nf">sqrt</span><span class="p">(</span><span class="n">forest.pred</span><span class="o">$</span><span class="n">variance.estimates</span><span class="p">)</span>

<span class="c1"># A vector of labels for plotting below</span>
<span class="n">labels</span> <span class="o">&lt;-</span> <span class="nf">mapply</span><span class="p">(</span><span class="nf">function</span><span class="p">(</span><span class="n">est</span><span class="p">,</span> <span class="n">se</span><span class="p">)</span> <span class="nf">paste0</span><span class="p">(</span><span class="nf">signif</span><span class="p">(</span><span class="n">est</span><span class="p">,</span> <span class="m">3</span><span class="p">),</span> <span class="s">&quot;\n&quot;</span><span class="p">,</span> <span class="s">&quot;(&quot;</span><span class="p">,</span> <span class="nf">signif</span><span class="p">(</span><span class="n">se</span><span class="p">,</span> <span class="m">3</span><span class="p">),</span> <span class="s">&quot;)&quot;</span><span class="p">),</span> <span class="n">tau.hat</span><span class="p">,</span> <span class="n">tau.hat.se</span><span class="p">)</span>
<span class="n">df</span> <span class="o">&lt;-</span> <span class="nf">data.frame</span><span class="p">(</span><span class="n">X.grid</span><span class="p">,</span> <span class="n">tau.hat</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>

<span class="c1"># Plotting</span>
<span class="nf">ggplot</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">+</span>
    <span class="nf">aes</span><span class="p">(</span><span class="n">age</span><span class="p">,</span> <span class="n">polviews</span><span class="p">)</span> <span class="o">+</span>
    <span class="nf">geom_tile</span><span class="p">(</span><span class="nf">aes</span><span class="p">(</span><span class="n">fill</span> <span class="o">=</span> <span class="n">tau.hat</span><span class="p">))</span> <span class="o">+</span> 
    <span class="nf">geom_text</span><span class="p">(</span><span class="nf">aes</span><span class="p">(</span><span class="n">label</span> <span class="o">=</span> <span class="n">labels</span><span class="p">))</span> <span class="o">+</span>
    <span class="nf">scale_fill_gradient</span><span class="p">(</span><span class="n">low</span> <span class="o">=</span> <span class="s">&quot;blue&quot;</span><span class="p">,</span> <span class="n">high</span> <span class="o">=</span> <span class="s">&quot;orange&quot;</span><span class="p">)</span> <span class="o">+</span>
    <span class="nf">scale_y_continuous</span><span class="p">(</span><span class="s">&quot;polviews&quot;</span><span class="p">,</span> <span class="n">breaks</span><span class="o">=</span><span class="n">x1.grid</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="nf">signif</span><span class="p">(</span><span class="n">x1.grid</span><span class="p">,</span> <span class="m">2</span><span class="p">))</span> <span class="o">+</span>
    <span class="nf">scale_x_continuous</span><span class="p">(</span><span class="s">&quot;age&quot;</span><span class="p">,</span> <span class="n">breaks</span><span class="o">=</span><span class="n">x2.grid</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="nf">signif</span><span class="p">(</span><span class="n">x2.grid</span><span class="p">,</span> <span class="m">2</span><span class="p">))</span> <span class="o">+</span>
    <span class="nf">ggtitle</span><span class="p">(</span><span class="nf">paste0</span><span class="p">(</span><span class="s">&quot;Predicted treatment effect varying &#39;&quot;</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="s">&quot;&#39; and &#39;&quot;</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="s">&quot;&#39; (other variables fixed at median)&quot;</span><span class="p">))</span> <span class="o">+</span>
    <span class="nf">theme_minimal</span><span class="p">()</span> <span class="o">+</span>
    <span class="nf">theme</span><span class="p">(</span><span class="n">plot.title</span> <span class="o">=</span> <span class="nf">element_text</span><span class="p">(</span><span class="n">size</span> <span class="o">=</span> <span class="m">10</span><span class="p">,</span> <span class="n">face</span> <span class="o">=</span> <span class="s">&quot;bold&quot;</span><span class="p">))</span> 
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/4_heterogeneous_treatment_effect_1_63_0.png" src="../_images/4_heterogeneous_treatment_effect_1_63_0.png" />
</div>
</div>
</section>
</section>
</section>
<section id="further-reading">
<h2><span class="section-number">4.3. </span>Further reading<a class="headerlink" href="#further-reading" title="Permalink to this headline">#</a></h2>
<p>A readable summary of different method for hypothesis testing correction is laid out in the introduction to <a class="reference external" href="http://ftp.iza.org/dp12845.pdf">Clarke, Romano and Wolf (2009)</a>.</p>
<p><a class="reference external" href="https://arxiv.org/abs/1902.07409">Athey and Wager (2019)</a> shows an application of causal forests to heterogeity analysis in a setting with clustering.</p>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "d2cml-ai/mgtecon634_r",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "r"
        },
        kernelOptions: {
            kernelName: "ir",
            path: "./notebooks"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'ir'</script>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="3_average_treatment_effect_1.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title"><span class="section-number">3. </span>ATE I: Binary treatment</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="5_policy_evaluation_1.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title"><span class="section-number">5. </span>Policy Evaluation I - Binary Treatment</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By Phd Susan Athey<br/>
  
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>